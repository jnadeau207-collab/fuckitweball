{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jesse/Documents/cartfax_complete_v2/pages/api/auth/%5B...nextauth%5D.ts"],"sourcesContent":["import NextAuth, { NextAuthOptions } from 'next-auth';\nimport CredentialsProvider from 'next-auth/providers/credentials';\nimport { PrismaClient } from '@prisma/client';\nimport bcrypt from 'bcrypt';\n\nconst prisma = new PrismaClient();\n\nexport const authOptions: NextAuthOptions = {\n  session: { strategy: 'jwt' },\n  providers: [\n    CredentialsProvider({\n      name: 'Credentials',\n      credentials: {\n        email: {\n          label: 'Email',\n          type: 'email',\n          placeholder: 'admin@example.com',\n        },\n        password: { label: 'Password', type: 'password' },\n      },\n      async authorize(credentials) {\n        if (!credentials?.email || !credentials?.password) return null;\n\n        const user = await prisma.adminUser.findUnique({\n          where: { email: credentials.email },\n        });\n        if (!user) return null;\n\n        const ok = await bcrypt.compare(credentials.password, user.password);\n        if (!ok) return null;\n\n        return {\n          id: user.id.toString(),\n          email: user.email,\n          name: user.name || undefined,\n          role: user.role,\n        } as any;\n      },\n    }),\n  ],\n  callbacks: {\n    async jwt({ token, user }) {\n      if (user) {\n        token.role = (user as any).role ?? 'admin';\n        token.id = (user as any).id ?? token.id;\n      }\n      return token;\n    },\n    async session({ session, token }) {\n      (session as any).user = session.user ?? {};\n      (session as any).user.role = token.role;\n      (session as any).user.id = token.id;\n      return session;\n    },\n  },\n  secret: process.env.NEXTAUTH_SECRET,\n};\n\nexport default NextAuth(authOptions);\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AACA;;;;;AAEA,MAAM,SAAS,IAAI,6IAAY;AAExB,MAAM,cAA+B;IAC1C,SAAS;QAAE,UAAU;IAAM;IAC3B,WAAW;QACT,IAAA,oLAAmB,EAAC;YAClB,MAAM;YACN,aAAa;gBACX,OAAO;oBACL,OAAO;oBACP,MAAM;oBACN,aAAa;gBACf;gBACA,UAAU;oBAAE,OAAO;oBAAY,MAAM;gBAAW;YAClD;YACA,MAAM,WAAU,WAAW;gBACzB,IAAI,CAAC,aAAa,SAAS,CAAC,aAAa,UAAU,OAAO;gBAE1D,MAAM,OAAO,MAAM,OAAO,SAAS,CAAC,UAAU,CAAC;oBAC7C,OAAO;wBAAE,OAAO,YAAY,KAAK;oBAAC;gBACpC;gBACA,IAAI,CAAC,MAAM,OAAO;gBAElB,MAAM,KAAK,MAAM,gHAAM,CAAC,OAAO,CAAC,YAAY,QAAQ,EAAE,KAAK,QAAQ;gBACnE,IAAI,CAAC,IAAI,OAAO;gBAEhB,OAAO;oBACL,IAAI,KAAK,EAAE,CAAC,QAAQ;oBACpB,OAAO,KAAK,KAAK;oBACjB,MAAM,KAAK,IAAI,IAAI;oBACnB,MAAM,KAAK,IAAI;gBACjB;YACF;QACF;KACD;IACD,WAAW;QACT,MAAM,KAAI,EAAE,KAAK,EAAE,IAAI,EAAE;YACvB,IAAI,MAAM;gBACR,MAAM,IAAI,GAAG,AAAC,KAAa,IAAI,IAAI;gBACnC,MAAM,EAAE,GAAG,AAAC,KAAa,EAAE,IAAI,MAAM,EAAE;YACzC;YACA,OAAO;QACT;QACA,MAAM,SAAQ,EAAE,OAAO,EAAE,KAAK,EAAE;YAC7B,QAAgB,IAAI,GAAG,QAAQ,IAAI,IAAI,CAAC;YACxC,QAAgB,IAAI,CAAC,IAAI,GAAG,MAAM,IAAI;YACtC,QAAgB,IAAI,CAAC,EAAE,GAAG,MAAM,EAAE;YACnC,OAAO;QACT;IACF;IACA,QAAQ,QAAQ,GAAG,CAAC,eAAe;AACrC;uCAEe,IAAA,4HAAQ,EAAC"}},
    {"offset": {"line": 120, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jesse/Documents/cartfax_complete_v2/pages/api/admin/batches.ts"],"sourcesContent":["// pages/api/admin/batches.ts\nimport type { NextApiRequest, NextApiResponse } from 'next';\nimport { getServerSession } from 'next-auth/next';\nimport { authOptions } from '../auth/[...nextauth]';\nimport { PrismaClient } from '@prisma/client';\n\nconst prisma = new PrismaClient();\n\nexport default async function handler(\n  req: NextApiRequest,\n  res: NextApiResponse\n) {\n  // âœ… Same auth pattern as /api/admin/uploads\n  const session = await getServerSession(req, res, authOptions);\n  if (!session) {\n    return res.status(401).json({ error: 'Unauthorized' });\n  }\n\n  if (req.method === 'GET') {\n    const { stateCode, q } = req.query;\n\n    const where: any = {};\n\n    // Optional state filter (used by /admin/states/[stateCode])\n    if (typeof stateCode === 'string' && stateCode.trim() !== '') {\n      where.stateCode = stateCode.toUpperCase();\n    }\n\n    // Optional text search (batch code, product name, category)\n    if (typeof q === 'string' && q.trim() !== '') {\n      const search = q.trim();\n      where.OR = [\n        { batchCode: { contains: search, mode: 'insensitive' } },\n        { productName: { contains: search, mode: 'insensitive' } },\n        { primaryCategory: { contains: search, mode: 'insensitive' } },\n        { subCategory: { contains: search, mode: 'insensitive' } },\n      ];\n    }\n\n    const batches = await prisma.batch.findMany({\n      where,\n      orderBy: { createdAt: 'desc' },\n      include: {\n        brand: true,\n        labResults: {\n          orderBy: { testedAt: 'desc' },\n          take: 1,\n          include: { lab: true },\n        },\n      },\n    });\n\n    const mapped = batches.map((b) => {\n      const latest = b.labResults[0];\n\n      return {\n        id: b.id,\n        batchCode: b.batchCode,\n        productName: b.productName,\n        productSku: b.productSku,\n        primaryCategory: b.primaryCategory,\n        subCategory: b.subCategory,\n        jurisdiction: b.jurisdiction,\n        stateCode: b.stateCode,\n        isActive: b.isActive,\n        createdAt: b.createdAt,\n\n        brand: b.brand\n          ? {\n              id: b.brand.id,\n              name: b.brand.name,\n            }\n          : null,\n\n        latestLab: latest\n          ? {\n              id: latest.id,\n              testedAt: latest.testedAt,\n              thcPercent: latest.thcPercent,\n              cbdPercent: latest.cbdPercent,\n              totalCannabinoidsPercent: latest.totalCannabinoidsPercent,\n              passed: latest.passed,\n              labName: latest.lab?.name ?? null,\n            }\n          : null,\n      };\n    });\n\n    return res.json(mapped);\n  }\n\n  if (req.method === 'POST') {\n    const body = req.body || {};\n\n    const created = await prisma.batch.create({\n      data: {\n        batchCode: body.batchCode,\n        productName: body.productName ?? null,\n        productSku: body.productSku ?? null,\n        primaryCategory: body.primaryCategory ?? null,\n        subCategory: body.subCategory ?? null,\n        jurisdiction: body.jurisdiction ?? null,\n        stateCode: body.stateCode ? String(body.stateCode).toUpperCase() : null,\n        brandId:\n          body.brandId === null || body.brandId === undefined\n            ? null\n            : Number(body.brandId),\n        harvestDate: body.harvestDate ? new Date(body.harvestDate) : null,\n        productionDate: body.productionDate\n          ? new Date(body.productionDate)\n          : null,\n        packageDate: body.packageDate ? new Date(body.packageDate) : null,\n        expirationDate: body.expirationDate\n          ? new Date(body.expirationDate)\n          : null,\n        isActive:\n          typeof body.isActive === 'boolean' ? body.isActive : true,\n        notes: body.notes ?? null,\n      },\n    });\n\n    return res.status(201).json(created);\n  }\n\n  if (req.method === 'PUT') {\n    const id = Number(req.query.id);\n    if (!id) {\n      return res.status(400).json({ error: 'missing id' });\n    }\n\n    const body = req.body || {};\n\n    const updated = await prisma.batch.update({\n      where: { id },\n      data: {\n        batchCode: body.batchCode,\n        productName: body.productName ?? null,\n        productSku: body.productSku ?? null,\n        primaryCategory: body.primaryCategory ?? null,\n        subCategory: body.subCategory ?? null,\n        jurisdiction: body.jurisdiction ?? null,\n        stateCode: body.stateCode ? String(body.stateCode).toUpperCase() : null,\n        brandId:\n          body.brandId === null || body.brandId === undefined\n            ? null\n            : Number(body.brandId),\n        harvestDate: body.harvestDate ? new Date(body.harvestDate) : null,\n        productionDate: body.productionDate\n          ? new Date(body.productionDate)\n          : null,\n        packageDate: body.packageDate ? new Date(body.packageDate) : null,\n        expirationDate: body.expirationDate\n          ? new Date(body.expirationDate)\n          : null,\n        isActive:\n          typeof body.isActive === 'boolean' ? body.isActive : true,\n        notes: body.notes ?? null,\n      },\n    });\n\n    return res.json(updated);\n  }\n\n  if (req.method === 'DELETE') {\n    const id = Number(req.query.id);\n    if (!id) {\n      return res.status(400).json({ error: 'missing id' });\n    }\n\n    try {\n      // Remove child lab results first to avoid FK errors\n      await prisma.labResult.deleteMany({\n        where: { batchId: id },\n      });\n\n      await prisma.batch.delete({\n        where: { id },\n      });\n\n      // 204 = no content (what your client already expects)\n      return res.status(204).end();\n    } catch (e: any) {\n      console.error('Failed to delete batch', e);\n      return res\n        .status(500)\n        .json({ error: e?.message || 'Failed to delete batch' });\n    }\n  }\n\n  return res.status(405).end();\n}\n"],"names":[],"mappings":"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"}}]
}