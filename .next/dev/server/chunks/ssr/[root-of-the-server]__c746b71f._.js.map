{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jesse/Documents/cartfax_complete_v2/components/GlobeStates.tsx"],"sourcesContent":["import React, {\n  useCallback,\n  useEffect,\n  useMemo,\n  useRef,\n  useState,\n} from 'react';\nimport Globe from 'react-globe.gl';\nimport * as topojson from 'topojson-client';\nimport type { FeatureCollection, Feature } from 'geojson';\nimport {\n  JurisdictionId,\n  jurisdictionById,\n} from '../lib/jurisdictions'; // Correct relative import\n\nexport interface RegionSelection {\n  id: string;\n  name: string;\n}\n\ninterface GlobeStatesProps {\n  jurisdiction: JurisdictionId;\n  onRegionSelect?: (region: RegionSelection) => void;\n  onViewChange?: (altitude: number) => void;\n}\n\n// Helper to safely pull a property from a feature\nfunction getProp(feature: Feature, key: string): string | null {\n  const value = (feature.properties as any)?.[key];\n  if (value == null) return null;\n  return String(value);\n}\n\n// Fallback: use \"name\" property if present\nfunction getName(feature: Feature): string {\n  const props = (feature.properties || {}) as any;\n  return String(props.name ?? props.NAME_1 ?? props.NAME ?? 'Unknown region');\n}\n\n// Altitude constants for the \"explosion\" effect\nconst BASE_ALTITUDE = 0.008;\nconst SELECTED_EXTRA = 0.022;\nconst HOVER_EXTRA = 0.010;\n\nconst GlobeStates: React.FC<GlobeStatesProps> = ({\n  jurisdiction,\n  onRegionSelect,\n  onViewChange,\n}) => {\n  const globeRef = useRef<any>(null);\n\n  const [features, setFeatures] = useState<Feature[]>([]);\n  const [hovered, setHovered] = useState<Feature | null>(null);\n  const [selectedId, setSelectedId] = useState<string | null>(null);\n\n  const spec = jurisdictionById[jurisdiction];\n\n  // 1. Load ADM1 polygons for active jurisdiction (TopoJSON Loader)\n  useEffect(() => {\n    let cancelled = false;\n\n    async function load() {\n      if (!spec.topoJsonPath) {\n        setFeatures([]);\n        return;\n      }\n\n      try {\n        const res = await fetch(spec.topoJsonPath);\n        if (!res.ok) {\n          console.warn(\n            `Failed to load topojson for ${spec.id}: ${res.status}`,\n          );\n          if (!cancelled) setFeatures([]);\n          return;\n        }\n\n        const topo = await res.json();\n        const objects = (topo as any).objects;\n        // Use the specified object name or default to the first one found\n        const objectName =\n          spec.topoObjectName || Object.keys(objects)[0];\n        const fc = topojson.feature(\n          topo as any,\n          objects[objectName],\n        ) as FeatureCollection;\n\n        if (!cancelled) {\n          setFeatures(fc.features);\n        }\n      } catch (err) {\n        console.error('Error loading TopoJSON', err);\n        if (!cancelled) setFeatures([]);\n      }\n    }\n\n    setSelectedId(null);\n    setHovered(null);\n    load();\n\n    return () => {\n      cancelled = true;\n    };\n  }, [spec]);\n\n  // 2. Focus camera when jurisdiction changes (Fixes previous centering issues)\n  useEffect(() => {\n    const globe = globeRef.current;\n    if (!globe) return;\n\n    const { lat, lng, altitude } = spec.focus;\n    // The previous fix of removing 'animateIn' is implicit here: \n    // the component uses 'animateIn' on the globe itself, but the \n    // useEffect hook immediately forces the correct position using \n    // the library's built-in transition (1000ms), guaranteeing the focus.\n    globe.pointOfView({ lat, lng, altitude }, 1000);\n  }, [spec]);\n\n  // 3. Report altitude back up on camera moves\n  useEffect(() => {\n    if (!globeRef.current || !onViewChange) return;\n\n    const globe = globeRef.current;\n    const controls = globe.controls?.();\n    if (!controls) return;\n\n    const handleChange = () => {\n      const pov = globe.pointOfView();\n      if (pov && typeof pov.altitude === 'number') {\n        onViewChange(pov.altitude);\n      }\n    };\n\n    controls.addEventListener('change', handleChange);\n    return () => {\n      controls.removeEventListener('change', handleChange);\n    };\n  }, [onViewChange]);\n\n  // 4. Altitude / explosion logic (The visual \"lift\")\n  const polygonAltitude = useCallback(\n    (f: Feature) => {\n      const idProp = spec.featureIdProp;\n      const id = getProp(f, idProp);\n      const isSelected = id && selectedId && id === selectedId;\n      const isHovered = hovered === f;\n\n      let extra = 0;\n      if (isSelected) extra += SELECTED_EXTRA;\n      if (isHovered) extra += HOVER_EXTRA;\n\n      return BASE_ALTITUDE + extra;\n    },\n    [hovered, selectedId, spec.featureIdProp],\n  );\n\n  // 5. Polygon colors (Simple, Tailwind-based colors for performance)\n  const polygonCapColor = useCallback(\n    (f: Feature) => {\n      const id = getProp(f, spec.featureIdProp);\n      const isSelected = id && selectedId && id === selectedId;\n      const isHovered = hovered === f;\n\n      if (isSelected) return '#22c55e'; // Green when selected\n      if (isHovered) return '#4ade80'; // Lighter green when hovered\n      return 'rgba(15,23,42,0.98)'; // Dark slate-900 for default regions\n    },\n    [hovered, selectedId, spec.featureIdProp],\n  );\n\n  const polygonStrokeColor = useCallback(\n    (f: Feature) => {\n      const id = getProp(f, spec.featureIdProp);\n      const isSelected = id && selectedId && id === selectedId;\n      if (isSelected) return 'rgba(34,197,94,0.9)'; // Bright green stroke when selected\n      return 'rgba(30,64,175,0.4)'; // Subtle blue stroke otherwise\n    },\n    [selectedId, spec.featureIdProp],\n  );\n\n  const polygonsData = useMemo(() => features, [features]);\n\n  // 6. Click Handler (The navigation tool)\n  const handleClick = useCallback(\n    (f: Feature) => {\n      const id =\n        getProp(f, spec.featureIdProp) ?? getName(f);\n\n      setSelectedId(id);\n\n      if (onRegionSelect) {\n        onRegionSelect({\n          id,\n          name: getName(f),\n        });\n      }\n\n      // Gently nudge camera toward clicked region\n      if (globeRef.current) {\n        const centroid = (f as any).properties?.centroid;\n        if (\n          centroid &&\n          typeof centroid[1] === 'number' &&\n          typeof centroid[0] === 'number'\n        ) {\n          globeRef.current.pointOfView(\n            {\n              lat: centroid[1],\n              lng: centroid[0],\n              altitude: spec.focus.altitude,\n            },\n            700,\n          );\n        }\n      }\n    },\n    [onRegionSelect, spec.featureIdProp, spec.focus.altitude],\n  );\n\n  return (\n    <div className=\"h-full w-full\">\n      <Globe\n        ref={globeRef}\n        backgroundColor=\"rgba(0,0,0,1)\"\n        animateIn // Allows a smooth initial fly-in\n        // Base sphere texture â€“ simple + fast\n        globeImageUrl=\"/textures/earth-base.jpg\"\n        // Only draw polygons for the active jurisdiction\n        polygonsData={polygonsData}\n        polygonAltitude={polygonAltitude}\n        polygonCapColor={polygonCapColor}\n        polygonSideColor={() => 'rgba(15,23,42,1)'} // Side color for the \"punched out\" effect\n        polygonStrokeColor={polygonStrokeColor}\n        polygonsTransitionDuration={260}\n        polygonLabel={(f: Feature) => getName(f)}\n        onPolygonHover={(f: Feature | null) => setHovered(f)}\n        onPolygonClick={(f: Feature) => handleClick(f)}\n        // FIX 6: Add light to improve texture/finish realism (removed from old file structure)\n        lights={[\n            {\n                point: { lat: 30, lng: -100, altitude: 2.0 },\n                color: '#ffffff',\n                intensity: 1.5,\n            },\n        ]}\n      />\n    </div>\n  );\n};\n\nexport default GlobeStates;"],"names":[],"mappings":"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"}}]
}