{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 28, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jesse/Documents/cartfax_complete_v2/pages/admin/states/%5BstateCode%5D.tsx"],"sourcesContent":["import { useRouter } from 'next/router';\r\nimport { useSession } from 'next-auth/react';\r\nimport { useEffect, useMemo, useState } from 'react';\r\n\r\ntype Brand = {\r\n  id: number;\r\n  name: string;\r\n};\r\n\r\ntype LabResult = {\r\n  id: number;\r\n  thcPercent: number | null;\r\n  totalCannabinoidsPercent: number | null;\r\n  passed: boolean | null;\r\n};\r\n\r\ntype Batch = {\r\n  id: number;\r\n  batchCode: string;\r\n  productName?: string | null;\r\n  productCategory?: string | null;\r\n  productSubcategory?: string | null;\r\n  stateCode?: string | null;\r\n  isActive: boolean;\r\n  createdAt: string;\r\n  brand?: Brand | null;\r\n  labResults?: LabResult[];\r\n};\r\n\r\nexport default function AdminStateDetail() {\r\n  const router = useRouter();\r\n  const { data: session } = useSession();\r\n  const { stateCode } = router.query;\r\n\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [batches, setBatches] = useState<Batch[]>([]);\r\n  const [activeBrandId, setActiveBrandId] = useState<number | 'all'>('all');\r\n  const [search, setSearch] = useState('');\r\n\r\n  useEffect(() => {\r\n    if (!session) return;\r\n    if (!stateCode || typeof stateCode !== 'string') return;\r\n    fetchBatches(stateCode);\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [session, stateCode]);\r\n\r\n  async function fetchBatches(code: string) {\r\n    try {\r\n      setLoading(true);\r\n      setError(null);\r\n      const params = new URLSearchParams();\r\n      params.set('stateCode', code);\r\n      const res = await fetch(`/api/admin/batches?${params.toString()}`);\r\n      if (!res.ok) {\r\n        const txt = await res.text();\r\n        throw new Error(txt || 'Failed to load batches');\r\n      }\r\n      const data: Batch[] = await res.json();\r\n      setBatches(data);\r\n    } catch (e: any) {\r\n      console.error('Failed to fetch batches for state', e);\r\n      setError(e.message || 'Failed to load batches');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  const brands = useMemo(() => {\r\n    const map = new Map<number, Brand>();\r\n    for (const b of batches) {\r\n      if (b.brand) {\r\n        map.set(b.brand.id, b.brand);\r\n      }\r\n    }\r\n    return Array.from(map.values()).sort((a, b) =>\r\n      a.name.localeCompare(b.name)\r\n    );\r\n  }, [batches]);\r\n\r\n  const filteredBatches = useMemo(() => {\r\n    let list = batches;\r\n\r\n    if (activeBrandId !== 'all') {\r\n      list = list.filter((b) => b.brand && b.brand.id === activeBrandId);\r\n    }\r\n\r\n    if (search.trim().length > 0) {\r\n      const q = search.trim().toLowerCase();\r\n      list = list.filter(\r\n        (b) =>\r\n          b.batchCode.toLowerCase().includes(q) ||\r\n          (b.productName || '').toLowerCase().includes(q) ||\r\n          (b.productCategory || '').toLowerCase().includes(q)\r\n      );\r\n    }\r\n\r\n    return list;\r\n  }, [batches, activeBrandId, search]);\r\n\r\n  const totalBatches = batches.length;\r\n  const totalBrands = brands.length;\r\n  const totalLabResults = batches.reduce(\r\n    (acc, b) => acc + (b.labResults?.length || 0),\r\n    0\r\n  );\r\n\r\n  const code =\r\n    typeof stateCode === 'string' ? stateCode.toUpperCase() : '??';\r\n\r\n  if (!session) {\r\n    return (\r\n      <div className=\"p-6\">\r\n        <p className=\"text-sm text-slate-300\">\r\n          Sign in as an admin to view state details.\r\n        </p>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"p-6 max-w-6xl mx-auto space-y-6\">\r\n      <div className=\"flex items-center justify-between gap-3\">\r\n        <div>\r\n          <button\r\n            onClick={() => router.push('/admin/states')}\r\n            className=\"text-xs text-sky-400 hover:text-sky-300 mb-1\"\r\n          >\r\n            ← Back to state map\r\n          </button>\r\n          <h1 className=\"text-2xl font-semibold mb-1\">\r\n            {code} · batches & lab results\r\n          </h1>\r\n          <p className=\"text-sm text-slate-400\">\r\n            Exploring all batches currently assigned to <span>{code}</span>.\r\n            Use brand filters and search to stay sane with large datasets.\r\n          </p>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Summary cards */}\r\n      <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm\">\r\n        <div className=\"rounded-xl border border-slate-800 bg-slate-900/70 p-3\">\r\n          <div className=\"text-slate-400 text-xs mb-1\">\r\n            Total batches in {code}\r\n          </div>\r\n          <div className=\"text-xl font-semibold text-slate-100\">\r\n            {totalBatches}\r\n          </div>\r\n        </div>\r\n        <div className=\"rounded-xl border border-slate-800 bg-slate-900/70 p-3\">\r\n          <div className=\"text-slate-400 text-xs mb-1\">Unique brands</div>\r\n          <div className=\"text-xl font-semibold text-slate-100\">\r\n            {totalBrands}\r\n          </div>\r\n        </div>\r\n        <div className=\"rounded-xl border border-slate-800 bg-slate-900/70 p-3\">\r\n          <div className=\"text-slate-400 text-xs mb-1\">\r\n            Lab results linked\r\n          </div>\r\n          <div className=\"text-xl font-semibold text-slate-100\">\r\n            {totalLabResults}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Filters */}\r\n      <div className=\"rounded-xl border border-slate-800 bg-slate-900/70 p-4 space-y-3 text-xs\">\r\n        {error && (\r\n          <div className=\"text-red-400 bg-red-950/40 border border-red-700/60 rounded-md px-3 py-2 text-xs\">\r\n            {error}\r\n          </div>\r\n        )}\r\n\r\n        <div className=\"flex flex-col md:flex-row gap-3 md:items-end\">\r\n          <div className=\"flex-1\">\r\n            <label className=\"block mb-1 text-slate-300 text-xs\">\r\n              Search batches in {code}\r\n            </label>\r\n            <input\r\n              value={search}\r\n              onChange={(e) => setSearch(e.target.value)}\r\n              placeholder=\"Batch code, product name, category…\"\r\n              className=\"w-full p-1.5 rounded-md bg-slate-950 border border-slate-700 text-slate-100 placeholder:text-slate-500\"\r\n            />\r\n          </div>\r\n        </div>\r\n\r\n        {/* Brand filter chips */}\r\n        <div className=\"space-y-1\">\r\n          <div className=\"text-slate-400 text-[11px]\">\r\n            Filter by brand ({totalBrands})\r\n          </div>\r\n          <div className=\"flex flex-wrap gap-1\">\r\n            <button\r\n              onClick={() => setActiveBrandId('all')}\r\n              className={`px-2 py-1 rounded-full border text-[11px] ${\r\n                activeBrandId === 'all'\r\n                  ? 'bg-sky-500 text-slate-950 border-sky-400'\r\n                  : 'border-slate-700 text-slate-200 hover:border-sky-500'\r\n              }`}\r\n            >\r\n              All brands\r\n            </button>\r\n            {brands.map((b) => (\r\n              <button\r\n                key={b.id}\r\n                onClick={() => setActiveBrandId(b.id)}\r\n                className={`px-2 py-1 rounded-full border text-[11px] ${\r\n                  activeBrandId === b.id\r\n                    ? 'bg-sky-500 text-slate-950 border-sky-400'\r\n                    : 'border-slate-700 text-slate-200 hover:border-sky-500'\r\n                }`}\r\n              >\r\n                {b.name}\r\n              </button>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Batches list */}\r\n      <div className=\"rounded-xl border border-slate-800 bg-slate-900/70 p-4\">\r\n        <div className=\"flex items-center justify-between mb-2 text-xs text-slate-400\">\r\n          <div>\r\n            Showing{' '}\r\n            <span className=\"text-slate-100 font-semibold\">\r\n              {filteredBatches.length}\r\n            </span>{' '}\r\n            of <span className=\"font-semibold\">{totalBatches}</span> batches in{' '}\r\n            {code}\r\n          </div>\r\n          <button\r\n            onClick={() =>\r\n              stateCode && typeof stateCode === 'string'\r\n                ? fetchBatches(stateCode)\r\n                : null\r\n            }\r\n            className=\"px-2 py-1 rounded-md border border-slate-700 text-xs text-slate-200\"\r\n          >\r\n            Refresh\r\n          </button>\r\n        </div>\r\n\r\n        {loading && (\r\n          <div className=\"text-xs text-slate-400\">Loading batches…</div>\r\n        )}\r\n\r\n        {!loading && filteredBatches.length === 0 && (\r\n          <div className=\"text-xs text-slate-500\">\r\n            No batches match this filter in {code} yet.\r\n          </div>\r\n        )}\r\n\r\n        {!loading && filteredBatches.length > 0 && (\r\n          <div className=\"space-y-2\">\r\n            {filteredBatches.map((b) => {\r\n              const latestLab =\r\n                b.labResults && b.labResults.length > 0\r\n                  ? b.labResults[0]\r\n                  : null;\r\n\r\n              return (\r\n                <div\r\n                  key={b.id}\r\n                  className=\"rounded-lg border border-slate-800 bg-slate-950/80 p-3 flex flex-col md:flex-row md:items-center md:justify-between gap-2\"\r\n                >\r\n                  <div className=\"space-y-1 text-xs\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <span className=\"font-semibold text-slate-100\">\r\n                        {b.batchCode}\r\n                      </span>\r\n                      {b.isActive && (\r\n                        <span className=\"px-1.5 py-0.5 rounded-full bg-emerald-500/10 border border-emerald-500/40 text-[10px] text-emerald-300\">\r\n                          Active\r\n                        </span>\r\n                      )}\r\n                    </div>\r\n                    {b.productName && (\r\n                      <div className=\"text-slate-200\">{b.productName}</div>\r\n                    )}\r\n                    <div className=\"text-slate-400\">\r\n                      {b.productCategory || 'Uncategorized'}\r\n                      {b.productSubcategory\r\n                        ? ` · ${b.productSubcategory}`\r\n                        : ''}\r\n                      {b.brand ? ` · ${b.brand.name}` : ''}\r\n                    </div>\r\n                    <div className=\"text-slate-500\">\r\n                      Created{' '}\r\n                      {new Date(b.createdAt).toLocaleDateString()}\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"flex flex-wrap gap-2 text-[11px]\">\r\n                    {latestLab && (\r\n                      <>\r\n                        <div className=\"px-2 py-1 rounded-md border border-slate-700 text-slate-200\">\r\n                          THC:{' '}\r\n                          {latestLab.thcPercent != null\r\n                            ? `${latestLab.thcPercent.toFixed(1)}%`\r\n                            : '—'}\r\n                        </div>\r\n                        <div className=\"px-2 py-1 rounded-md border border-slate-700 text-slate-200\">\r\n                          Total cannabinoids:{' '}\r\n                          {latestLab.totalCannabinoidsPercent != null\r\n                            ? `${latestLab.totalCannabinoidsPercent.toFixed(\r\n                                1\r\n                              )}%`\r\n                            : '—'}\r\n                        </div>\r\n                        {latestLab.passed != null && (\r\n                          <div\r\n                            className={`px-2 py-1 rounded-md border ${\r\n                              latestLab.passed\r\n                                ? 'border-emerald-500/60 text-emerald-300'\r\n                                : 'border-red-500/60 text-red-400'\r\n                            }`}\r\n                          >\r\n                            {latestLab.passed ? 'Pass' : 'Fail'}\r\n                          </div>\r\n                        )}\r\n                      </>\r\n                    )}\r\n                    {!latestLab && (\r\n                      <div className=\"px-2 py-1 rounded-md border border-slate-700 text-slate-400\">\r\n                        No lab result linked\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              );\r\n            })}\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}}]
}