{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jesse/Documents/cartfax_complete_v2/pages/api/auth/%5B...nextauth%5D.ts"],"sourcesContent":["import NextAuth, { NextAuthOptions } from 'next-auth';\nimport CredentialsProvider from 'next-auth/providers/credentials';\nimport { PrismaClient } from '@prisma/client';\nimport bcrypt from 'bcrypt';\n\nconst prisma = new PrismaClient();\n\nexport const authOptions: NextAuthOptions = {\n  session: { strategy: 'jwt' },\n  providers: [\n    CredentialsProvider({\n      name: 'Credentials',\n      credentials: {\n        email: {\n          label: 'Email',\n          type: 'email',\n          placeholder: 'admin@example.com',\n        },\n        password: { label: 'Password', type: 'password' },\n      },\n      async authorize(credentials) {\n        if (!credentials?.email || !credentials?.password) return null;\n\n        const user = await prisma.adminUser.findUnique({\n          where: { email: credentials.email },\n        });\n        if (!user) return null;\n\n        const ok = await bcrypt.compare(credentials.password, user.password);\n        if (!ok) return null;\n\n        return {\n          id: user.id.toString(),\n          email: user.email,\n          name: user.name || undefined,\n          role: user.role,\n        } as any;\n      },\n    }),\n  ],\n  callbacks: {\n    async jwt({ token, user }) {\n      if (user) {\n        token.role = (user as any).role ?? 'admin';\n        token.id = (user as any).id ?? token.id;\n      }\n      return token;\n    },\n    async session({ session, token }) {\n      (session as any).user = session.user ?? {};\n      (session as any).user.role = token.role;\n      (session as any).user.id = token.id;\n      return session;\n    },\n  },\n  secret: process.env.NEXTAUTH_SECRET,\n};\n\nexport default NextAuth(authOptions);\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AACA;;;;;AAEA,MAAM,SAAS,IAAI,6IAAY;AAExB,MAAM,cAA+B;IAC1C,SAAS;QAAE,UAAU;IAAM;IAC3B,WAAW;QACT,IAAA,oLAAmB,EAAC;YAClB,MAAM;YACN,aAAa;gBACX,OAAO;oBACL,OAAO;oBACP,MAAM;oBACN,aAAa;gBACf;gBACA,UAAU;oBAAE,OAAO;oBAAY,MAAM;gBAAW;YAClD;YACA,MAAM,WAAU,WAAW;gBACzB,IAAI,CAAC,aAAa,SAAS,CAAC,aAAa,UAAU,OAAO;gBAE1D,MAAM,OAAO,MAAM,OAAO,SAAS,CAAC,UAAU,CAAC;oBAC7C,OAAO;wBAAE,OAAO,YAAY,KAAK;oBAAC;gBACpC;gBACA,IAAI,CAAC,MAAM,OAAO;gBAElB,MAAM,KAAK,MAAM,gHAAM,CAAC,OAAO,CAAC,YAAY,QAAQ,EAAE,KAAK,QAAQ;gBACnE,IAAI,CAAC,IAAI,OAAO;gBAEhB,OAAO;oBACL,IAAI,KAAK,EAAE,CAAC,QAAQ;oBACpB,OAAO,KAAK,KAAK;oBACjB,MAAM,KAAK,IAAI,IAAI;oBACnB,MAAM,KAAK,IAAI;gBACjB;YACF;QACF;KACD;IACD,WAAW;QACT,MAAM,KAAI,EAAE,KAAK,EAAE,IAAI,EAAE;YACvB,IAAI,MAAM;gBACR,MAAM,IAAI,GAAG,AAAC,KAAa,IAAI,IAAI;gBACnC,MAAM,EAAE,GAAG,AAAC,KAAa,EAAE,IAAI,MAAM,EAAE;YACzC;YACA,OAAO;QACT;QACA,MAAM,SAAQ,EAAE,OAAO,EAAE,KAAK,EAAE;YAC7B,QAAgB,IAAI,GAAG,QAAQ,IAAI,IAAI,CAAC;YACxC,QAAgB,IAAI,CAAC,IAAI,GAAG,MAAM,IAAI;YACtC,QAAgB,IAAI,CAAC,EAAE,GAAG,MAAM,EAAE;YACnC,OAAO;QACT;IACF;IACA,QAAQ,QAAQ,GAAG,CAAC,eAAe;AACrC;uCAEe,IAAA,4HAAQ,EAAC"}},
    {"offset": {"line": 150, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jesse/Documents/cartfax_complete_v2/lib/coaParsers/registry.ts"],"sourcesContent":["// lib/coaParsers/registry.ts\r\n\r\n/**\r\n * Shape of a normalized COA parse result that the upload pipeline can use\r\n * to wire up Lab, Batch, and LabResult records.\r\n */\r\nexport interface ParsedCoa {\r\n  // Lab identity\r\n  labSlug: string;          // e.g. \"nova-analytic-labs\"\r\n  labName: string;          // e.g. \"Nova Analytic Labs\"\r\n  labWebsite?: string;\r\n  labCity?: string;\r\n  labStateCode?: string;    // e.g. \"ME\"\r\n\r\n  // Batch / product\r\n  batchCode?: string;       // e.g. \"FAIL\", \"12345-ABC\"\r\n  productName?: string;     // strain / product name if present\r\n  sampleType?: string;      // \"FLOWER\", \"TINCTURE\", etc.\r\n  jurisdiction?: string;    // primary jurisdiction, usually state code\r\n  batchStateCode?: string;  // explicit state for Batch.stateCode if known\r\n\r\n  // Core dates (string so we can safely new Date() later)\r\n  producedAt?: string;      // e.g. \"2024-06-10\"\r\n  testedAt?: string;\r\n  reportedAt?: string;\r\n\r\n  // Potency\r\n  thcPercent?: number;\r\n  cbdPercent?: number;\r\n  totalCannabinoidsPercent?: number;\r\n  totalTerpenesPercent?: number;\r\n\r\n  // Safety flags\r\n  pesticidesPass?: boolean;\r\n  solventsPass?: boolean;\r\n  heavyMetalsPass?: boolean;\r\n  microbialsPass?: boolean;\r\n  moisturePercent?: number;\r\n  waterActivity?: number;\r\n\r\n  // Optional analyte summary / raw structure\r\n  analyteSummary?: any;\r\n\r\n  // Optional hint about source (for future remote fetches)\r\n  sourceUrl?: string;\r\n}\r\n\r\n/**\r\n * Main entry point – given extracted text, try to detect which lab\r\n * format this is and return a normalized ParsedCoa, or null if\r\n * we don't recognize the layout.\r\n */\r\nexport function parseCoa(text: string, fileName?: string): ParsedCoa | null {\r\n  const trimmed = (text || '').trim();\r\n  if (!trimmed) return null;\r\n\r\n  // Nova Analytic Labs – a.k.a. the one we care about right now\r\n  if (/NOVA\\s+ANALYTIC\\s+LABS/i.test(trimmed)) {\r\n    return parseNovaAnalyticLabs(trimmed);\r\n  }\r\n\r\n  // TODO: add more lab-specific parsers here as we go.\r\n  return null;\r\n}\r\n\r\n/**\r\n * Helper: parse a US-looking date like \"DEC 14, 2022\" into ISO string.\r\n */\r\nfunction parseUsDate(input?: string | null): string | undefined {\r\n  if (!input) return undefined;\r\n  const cleaned = input.trim();\r\n  if (!cleaned) return undefined;\r\n  const d = new Date(cleaned);\r\n  if (Number.isNaN(d.getTime())) return undefined;\r\n  return d.toISOString();\r\n}\r\n\r\n/**\r\n * Helper: parse flag patterns like \"PESTICIDESPASS\", \"PESTICIDES FAIL\", etc.\r\n */\r\nfunction parsePassFailFlag(text: string, label: string): boolean | undefined {\r\n  const re = new RegExp(label + '\\\\s*(PASS|FAIL)', 'i');\r\n  const m = text.match(re);\r\n  if (!m) return undefined;\r\n  return m[1].toUpperCase() === 'PASS';\r\n}\r\n\r\n/**\r\n * Parser for Nova Analytic Labs COAs.\r\n *\r\n * This is intentionally conservative – we only pull the bits we can\r\n * reliably infer across multiple examples (flower, tincture, etc.).\r\n */\r\nfunction parseNovaAnalyticLabs(text: string): ParsedCoa {\r\n  // --- Batch code ---\r\n  // Examples:\r\n  //   \"CLIENT: NOVA - PT ACCOUNT // BATCH: FAIL\"\r\n  //   \"... BATCH: NAL-250414-043\"\r\n  let batchCode: string | undefined;\r\n  const batchMatch =\r\n    text.match(/BATCH:\\s*([A-Z0-9\\-_.]+)/i) ||\r\n    text.match(/BATCH\\s+RESULT:\\s*([A-Z0-9\\-_.]+)/i);\r\n  if (batchMatch) {\r\n    batchCode = batchMatch[1].trim();\r\n  }\r\n\r\n  // --- Sample type / matrix ---\r\n  // e.g. \"MATRIX: FLOWER\", \"MATRIX: TINCTURE\"\r\n  let sampleType: string | undefined;\r\n  const matrixMatch = text.match(/MATRIX:\\s*([A-Z ]+)/i);\r\n  if (matrixMatch) {\r\n    sampleType = matrixMatch[1].trim();\r\n  }\r\n\r\n  // --- Product / \"name-ish\" ---\r\n  // Nova's example: \"COA EXAMPLE (FLOWER)\" – not super useful,\r\n  // but many partner COAs have more descriptive headers.\r\n  let productName: string | undefined;\r\n  const headerLineMatch = text.match(/COA\\s+EXAMPLE\\s*\\(([^)]+)\\)/i);\r\n  if (headerLineMatch) {\r\n    productName = headerLineMatch[1].trim();\r\n  }\r\n\r\n  // --- Produced / tested dates ---\r\n  // Example:\r\n  //   \"COA EXAMPLE (FLOWER) // PRODUCED: JUN 10, 2024\"\r\n  //   \"PREPARATION: DEC 14, 2022 // ANALYSIS: DEC 14, 2022\"\r\n  let producedAt: string | undefined;\r\n  let testedAt: string | undefined;\r\n\r\n  const producedMatch = text.match(/PRODUCED:\\s*([A-Z]{3}\\s+\\d{1,2},\\s+\\d{4})/i);\r\n  if (producedMatch) {\r\n    producedAt = parseUsDate(producedMatch[1]);\r\n  }\r\n\r\n  const analysisMatch = text.match(/ANALYSIS:\\s*([A-Z]{3}\\s+\\d{1,2},\\s+\\d{4})/i);\r\n  if (analysisMatch) {\r\n    testedAt = parseUsDate(analysisMatch[1]);\r\n  }\r\n\r\n  // --- Potency ---\r\n  // Example lines:\r\n  //   \"Δ-THC:28.5 %\"\r\n  //   \"TOTAL CANNABINOIDS:29.1 %\"\r\n  //   \"TOTAL TERPENES1.27 %\"\r\n  const thcMatch = text.match(/Δ-THC[:\\s]+([0-9.]+)\\s*%/i);\r\n  const totalCannMatch = text.match(/TOTAL\\s+CANNABINOIDS[:\\s]+([0-9.]+)\\s*%/i);\r\n  const cbdMatch = text.match(/CBD[:\\s]+([0-9.]+)\\s*%/i);\r\n  const totalTerpMatch = text.match(/TOTAL\\s+TERPENES[:\\s]*([0-9.]+)\\s*%/i);\r\n\r\n  const thcPercent = thcMatch ? parseFloat(thcMatch[1]) : undefined;\r\n  const totalCannabinoidsPercent = totalCannMatch\r\n    ? parseFloat(totalCannMatch[1])\r\n    : undefined;\r\n  const cbdPercent = cbdMatch ? parseFloat(cbdMatch[1]) : undefined;\r\n  const totalTerpenesPercent = totalTerpMatch\r\n    ? parseFloat(totalTerpMatch[1])\r\n    : undefined;\r\n\r\n  // --- Safety flags ---\r\n  // In the example we saw:\r\n  //   \"PESTICIDESFAIL\"\r\n  //   \"MICROBIALFAIL\"\r\n  //   \"METALSPASS\"\r\n  //   \"MYCOTOXINSPASS\"\r\n  const pesticidesPass = parsePassFailFlag(text, 'PESTICIDES');\r\n  const microbialsPass = parsePassFailFlag(text, 'MICROBIAL');\r\n  const heavyMetalsPass = parsePassFailFlag(text, 'METALS');\r\n  const solventsPass = parsePassFailFlag(text, 'SOLVENTS');\r\n\r\n  // --- Moisture / water activity (if we see them) ---\r\n  // Example snippet:\r\n  //   \"MOISTURE9.000.0100/0.0100\"\r\n  //   \"WATER ACTIVITY0.65 Aw...\"\r\n  let moisturePercent: number | undefined;\r\n  const moistureMatch = text.match(/MOISTURE\\s*([0-9.]+)\\s*%/i);\r\n  if (moistureMatch) {\r\n    moisturePercent = parseFloat(moistureMatch[1]);\r\n  }\r\n\r\n  let waterActivity: number | undefined;\r\n  const waterMatch = text.match(/WATER\\s+ACTIVITY\\s*([0-9.]+)\\s*Aw/i);\r\n  if (waterMatch) {\r\n    waterActivity = parseFloat(waterMatch[1]);\r\n  }\r\n\r\n  // --- Very lightweight analyte summary for now ---\r\n  const analytes: Array<{ analyte: string; percent?: number }> = [];\r\n  if (typeof thcPercent === 'number') {\r\n    analytes.push({ analyte: 'Δ-THC', percent: thcPercent });\r\n  }\r\n  if (typeof cbdPercent === 'number') {\r\n    analytes.push({ analyte: 'CBD', percent: cbdPercent });\r\n  }\r\n  if (typeof totalCannabinoidsPercent === 'number') {\r\n    analytes.push({\r\n      analyte: 'Total Cannabinoids',\r\n      percent: totalCannabinoidsPercent,\r\n    });\r\n  }\r\n  if (typeof totalTerpenesPercent === 'number') {\r\n    analytes.push({\r\n      analyte: 'Total Terpenes',\r\n      percent: totalTerpenesPercent,\r\n    });\r\n  }\r\n\r\n  // Nova is physically in Portland, ME – we can safely hard-code this\r\n  // for now so the state map & lab drill-downs work out of the box.\r\n  const labSlug = 'nova-analytic-labs';\r\n\r\n  return {\r\n    labSlug,\r\n    labName: 'Nova Analytic Labs',\r\n    labWebsite: 'https://testnovalabs.com',\r\n    labCity: 'Portland',\r\n    labStateCode: 'ME',\r\n\r\n    batchCode,\r\n    productName,\r\n    sampleType,\r\n    jurisdiction: 'ME',\r\n    batchStateCode: 'ME',\r\n\r\n    producedAt,\r\n    testedAt,\r\n    reportedAt: producedAt, // often the same for Nova's example COAs\r\n\r\n    thcPercent,\r\n    cbdPercent,\r\n    totalCannabinoidsPercent,\r\n    totalTerpenesPercent,\r\n\r\n    pesticidesPass,\r\n    microbialsPass,\r\n    heavyMetalsPass,\r\n    solventsPass,\r\n    moisturePercent,\r\n    waterActivity,\r\n\r\n    analyteSummary: analytes.length ? { analytes } : undefined,\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 329, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jesse/Documents/cartfax_complete_v2/pages/api/admin/uploads/index.ts"],"sourcesContent":["// pages/api/admin/uploads/index.ts\n\nimport type { NextApiRequest, NextApiResponse } from 'next';\nimport { getServerSession } from 'next-auth/next';\nimport { authOptions } from '../../auth/[...nextauth]';\nimport { PrismaClient } from '@prisma/client';\nimport multer from 'multer';\nimport pdfParse from 'pdf-parse';\nimport fs from 'fs/promises';\nimport path from 'path';\nimport crypto from 'crypto';\n\nimport { parseCoa, ParsedCoa } from '../../../../lib/coaParsers/registry';\n\nconst prisma = new PrismaClient();\n\n// Multer: keep file in memory; we decide where/how to write it.\nconst upload = multer({ storage: multer.memoryStorage() });\n\nfunction runMiddleware(\n  req: NextApiRequest,\n  res: NextApiResponse,\n  fn: Function\n): Promise<void> {\n  return new Promise((resolve, reject) => {\n    fn(req, res, (result: any) => {\n      if (result instanceof Error) return reject(result);\n      return resolve(result);\n    });\n  });\n}\n\nexport const config = {\n  api: {\n    bodyParser: false, // required for multer\n  },\n};\n\nexport default async function handler(\n  req: NextApiRequest,\n  res: NextApiResponse\n) {\n  const session = await getServerSession(req, res, authOptions);\n\n  if (!session || !session.user?.email) {\n    res.status(401).json({ error: 'Unauthorized' });\n    return;\n  }\n\n  if (req.method === 'GET') {\n    await handleGet(req, res);\n    return;\n  }\n\n  if (req.method === 'POST') {\n    await handlePost(req, res, session.user.email);\n    return;\n  }\n\n  res.setHeader('Allow', ['GET', 'POST']);\n  res.status(405).end('Method Not Allowed');\n}\n\n// ---------- GET: list uploaded documents ----------\n\nasync function handleGet(req: NextApiRequest, res: NextApiResponse) {\n  try {\n    const docs = await prisma.uploadedDocument.findMany({\n      orderBy: { createdAt: 'desc' },\n      select: {\n        id: true,\n        fileName: true,\n        mimeType: true,\n        size: true,\n        sha256: true,\n        batchCode: true,\n        labName: true,\n        createdAt: true,\n        verified: true,\n        extractedText: true,\n        labResult: {\n          select: { id: true },\n        },\n      },\n    });\n\n    res.json(docs);\n  } catch (e: any) {\n    console.error('Failed to list uploads', e);\n    res.status(500).json({ error: e?.message || 'Failed to list uploads' });\n  }\n}\n\n// ---------- POST: upload + parse + wire up lab/batch/labResult ----------\n\nasync function handlePost(\n  req: NextApiRequest,\n  res: NextApiResponse,\n  uploaderEmail: string\n) {\n  try {\n    // 1) Parse multipart form and grab the PDF\n    await runMiddleware(req, res, upload.single('file'));\n\n    const file = (req as any).file as Express.Multer.File | undefined;\n    if (!file) {\n      res.status(400).json({ error: 'Missing PDF file field \"file\"' });\n      return;\n    }\n\n    if (file.mimetype !== 'application/pdf') {\n      res.status(400).json({ error: 'Only PDF files are allowed.' });\n      return;\n    }\n\n    // 2) Hash for dedupe\n    const sha256 = crypto\n      .createHash('sha256')\n      .update(file.buffer)\n      .digest('hex');\n\n    const existing = await prisma.uploadedDocument.findUnique({\n      where: { sha256 },\n      include: {\n        labResult: true,\n      },\n    });\n\n    if (existing) {\n      // Already ingested – return the existing doc + labResult reference\n      res.json({ reused: true, document: existing, labResult: existing.labResult });\n      return;\n    }\n\n    // 3) Persist PDF to disk under uploads/coas/<sha>.pdf\n    const uploadDir = path.join(process.cwd(), 'uploads', 'coas');\n    await fs.mkdir(uploadDir, { recursive: true });\n\n    const diskFileName = `${sha256}.pdf`;\n    const absoluteFilePath = path.join(uploadDir, diskFileName);\n    const relativeFilePath = path.join('uploads', 'coas', diskFileName);\n\n    await fs.writeFile(absoluteFilePath, file.buffer);\n\n    // 4) Extract text with pdf-parse\n    const parsedPdf = await pdfParse(file.buffer);\n    const extractedText = parsedPdf.text || '';\n\n    // 5) Try to parse via lab-specific registry (Nova, etc.)\n    const parsed: ParsedCoa | null = parseCoa(extractedText, file.originalname);\n\n    // 6) Store UploadedDocument row\n    const uploadedDoc = await prisma.uploadedDocument.create({\n      data: {\n        filePath: relativeFilePath,\n        fileName: file.originalname,\n        mimeType: file.mimetype,\n        size: file.size,\n        sha256,\n        extractedText,\n        labName: parsed?.labName || null,\n        batchCode: parsed?.batchCode || null,\n        uploader: uploaderEmail,\n        verified: false,\n      },\n    });\n\n    // 7) If we didn't recognize the lab / batch, we stop here.\n    if (!parsed || !parsed.batchCode) {\n      res.json({\n        reused: false,\n        document: uploadedDoc,\n        labResult: null,\n        parsed: null,\n      });\n      return;\n    }\n\n    // ---------- Upsert Lab (Nova) ----------\n    let labRecord = null;\n    if (parsed.labSlug) {\n      labRecord = await prisma.lab.upsert({\n        where: { slug: parsed.labSlug },\n        update: {\n          name: parsed.labName,\n          website: parsed.labWebsite || undefined,\n          city: parsed.labCity || undefined,\n          stateCode: parsed.labStateCode || undefined,\n        },\n        create: {\n          slug: parsed.labSlug,\n          name: parsed.labName,\n          website: parsed.labWebsite || undefined,\n          city: parsed.labCity || undefined,\n          stateCode: parsed.labStateCode || undefined,\n        },\n      });\n    }\n\n    // ---------- Find or create Batch ----------\n    const batchStateCode =\n      parsed.batchStateCode || parsed.jurisdiction || parsed.labStateCode || null;\n\n    let batchRecord = await prisma.batch.findFirst({\n      where: {\n        batchCode: parsed.batchCode,\n        ...(batchStateCode ? { stateCode: batchStateCode } : {}),\n      },\n    });\n\n    if (batchRecord) {\n      batchRecord = await prisma.batch.update({\n        where: { id: batchRecord.id },\n        data: {\n          productName: parsed.productName ?? batchRecord.productName,\n          primaryCategory: parsed.sampleType ?? batchRecord.primaryCategory,\n          jurisdiction: parsed.jurisdiction ?? batchRecord.jurisdiction,\n          stateCode: batchStateCode ?? batchRecord.stateCode,\n        },\n      });\n    } else {\n      batchRecord = await prisma.batch.create({\n        data: {\n          batchCode: parsed.batchCode,\n          productName: parsed.productName ?? null,\n          primaryCategory: parsed.sampleType ?? null,\n          jurisdiction: parsed.jurisdiction ?? batchStateCode ?? null,\n          stateCode: batchStateCode,\n          isActive: true,\n        },\n      });\n    }\n\n    // ---------- Create LabResult linked to Batch + Lab + UploadedDocument ----------\n    const labResult = await prisma.labResult.create({\n      data: {\n        batch: {\n          connect: { id: batchRecord.id },\n        },\n        lab: labRecord\n          ? {\n              connect: { id: labRecord.id },\n            }\n          : undefined,\n        uploadedDocument: {\n          connect: { id: uploadedDoc.id },\n        },\n\n        testedAt: parsed.testedAt ? new Date(parsed.testedAt) : undefined,\n        reportedAt: parsed.reportedAt ? new Date(parsed.reportedAt) : undefined,\n\n        thcPercent:\n          typeof parsed.thcPercent === 'number' ? parsed.thcPercent : null,\n        cbdPercent:\n          typeof parsed.cbdPercent === 'number' ? parsed.cbdPercent : null,\n        totalCannabinoidsPercent:\n          typeof parsed.totalCannabinoidsPercent === 'number'\n            ? parsed.totalCannabinoidsPercent\n            : null,\n        totalTerpenesPercent:\n          typeof parsed.totalTerpenesPercent === 'number'\n            ? parsed.totalTerpenesPercent\n            : null,\n\n        pesticidesPass:\n          typeof parsed.pesticidesPass === 'boolean'\n            ? parsed.pesticidesPass\n            : null,\n        solventsPass:\n          typeof parsed.solventsPass === 'boolean'\n            ? parsed.solventsPass\n            : null,\n        heavyMetalsPass:\n          typeof parsed.heavyMetalsPass === 'boolean'\n            ? parsed.heavyMetalsPass\n            : null,\n        microbialsPass:\n          typeof parsed.microbialsPass === 'boolean'\n            ? parsed.microbialsPass\n            : null,\n\n        moisturePercent:\n          typeof parsed.moisturePercent === 'number'\n            ? parsed.moisturePercent\n            : null,\n        waterActivity:\n          typeof parsed.waterActivity === 'number'\n            ? parsed.waterActivity\n            : null,\n\n        analyteSummary: parsed.analyteSummary ?? null,\n        rawJson: null,\n        sourcePdfUrl: parsed.sourceUrl ?? null,\n      },\n    });\n\n    res.json({\n      reused: false,\n      document: uploadedDoc,\n      labResult,\n      parsed,\n    });\n  } catch (e: any) {\n    console.error('Error handling upload', e);\n    res\n      .status(500)\n      .json({ error: e?.message || 'Failed to handle COA upload' });\n  }\n}\n"],"names":[],"mappings":"AAAA,mCAAmC;;;;;;;AAGnC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;;;;;;;;;;AAEA,MAAM,SAAS,IAAI,6IAAY;AAE/B,gEAAgE;AAChE,MAAM,SAAS,IAAA,gHAAM,EAAC;IAAE,SAAS,gHAAM,CAAC,aAAa;AAAG;AAExD,SAAS,cACP,GAAmB,EACnB,GAAoB,EACpB,EAAY;IAEZ,OAAO,IAAI,QAAQ,CAAC,SAAS;QAC3B,GAAG,KAAK,KAAK,CAAC;YACZ,IAAI,kBAAkB,OAAO,OAAO,OAAO;YAC3C,OAAO,QAAQ;QACjB;IACF;AACF;AAEO,MAAM,SAAS;IACpB,KAAK;QACH,YAAY;IACd;AACF;AAEe,eAAe,QAC5B,GAAmB,EACnB,GAAoB;IAEpB,MAAM,UAAU,MAAM,IAAA,qJAAgB,EAAC,KAAK,KAAK,kJAAW;IAE5D,IAAI,CAAC,WAAW,CAAC,QAAQ,IAAI,EAAE,OAAO;QACpC,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAe;QAC7C;IACF;IAEA,IAAI,IAAI,MAAM,KAAK,OAAO;QACxB,MAAM,UAAU,KAAK;QACrB;IACF;IAEA,IAAI,IAAI,MAAM,KAAK,QAAQ;QACzB,MAAM,WAAW,KAAK,KAAK,QAAQ,IAAI,CAAC,KAAK;QAC7C;IACF;IAEA,IAAI,SAAS,CAAC,SAAS;QAAC;QAAO;KAAO;IACtC,IAAI,MAAM,CAAC,KAAK,GAAG,CAAC;AACtB;AAEA,qDAAqD;AAErD,eAAe,UAAU,GAAmB,EAAE,GAAoB;IAChE,IAAI;QACF,MAAM,OAAO,MAAM,OAAO,gBAAgB,CAAC,QAAQ,CAAC;YAClD,SAAS;gBAAE,WAAW;YAAO;YAC7B,QAAQ;gBACN,IAAI;gBACJ,UAAU;gBACV,UAAU;gBACV,MAAM;gBACN,QAAQ;gBACR,WAAW;gBACX,SAAS;gBACT,WAAW;gBACX,UAAU;gBACV,eAAe;gBACf,WAAW;oBACT,QAAQ;wBAAE,IAAI;oBAAK;gBACrB;YACF;QACF;QAEA,IAAI,IAAI,CAAC;IACX,EAAE,OAAO,GAAQ;QACf,QAAQ,KAAK,CAAC,0BAA0B;QACxC,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO,GAAG,WAAW;QAAyB;IACvE;AACF;AAEA,2EAA2E;AAE3E,eAAe,WACb,GAAmB,EACnB,GAAoB,EACpB,aAAqB;IAErB,IAAI;QACF,2CAA2C;QAC3C,MAAM,cAAc,KAAK,KAAK,OAAO,MAAM,CAAC;QAE5C,MAAM,OAAO,AAAC,IAAY,IAAI;QAC9B,IAAI,CAAC,MAAM;YACT,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAgC;YAC9D;QACF;QAEA,IAAI,KAAK,QAAQ,KAAK,mBAAmB;YACvC,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAA8B;YAC5D;QACF;QAEA,qBAAqB;QACrB,MAAM,SAAS,gHAAM,CAClB,UAAU,CAAC,UACX,MAAM,CAAC,KAAK,MAAM,EAClB,MAAM,CAAC;QAEV,MAAM,WAAW,MAAM,OAAO,gBAAgB,CAAC,UAAU,CAAC;YACxD,OAAO;gBAAE;YAAO;YAChB,SAAS;gBACP,WAAW;YACb;QACF;QAEA,IAAI,UAAU;YACZ,mEAAmE;YACnE,IAAI,IAAI,CAAC;gBAAE,QAAQ;gBAAM,UAAU;gBAAU,WAAW,SAAS,SAAS;YAAC;YAC3E;QACF;QAEA,sDAAsD;QACtD,MAAM,YAAY,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,WAAW;QACtD,MAAM,gIAAE,CAAC,KAAK,CAAC,WAAW;YAAE,WAAW;QAAK;QAE5C,MAAM,eAAe,GAAG,OAAO,IAAI,CAAC;QACpC,MAAM,mBAAmB,4GAAI,CAAC,IAAI,CAAC,WAAW;QAC9C,MAAM,mBAAmB,4GAAI,CAAC,IAAI,CAAC,WAAW,QAAQ;QAEtD,MAAM,gIAAE,CAAC,SAAS,CAAC,kBAAkB,KAAK,MAAM;QAEhD,iCAAiC;QACjC,MAAM,YAAY,MAAM,IAAA,4HAAQ,EAAC,KAAK,MAAM;QAC5C,MAAM,gBAAgB,UAAU,IAAI,IAAI;QAExC,yDAAyD;QACzD,MAAM,SAA2B,IAAA,kIAAQ,EAAC,eAAe,KAAK,YAAY;QAE1E,gCAAgC;QAChC,MAAM,cAAc,MAAM,OAAO,gBAAgB,CAAC,MAAM,CAAC;YACvD,MAAM;gBACJ,UAAU;gBACV,UAAU,KAAK,YAAY;gBAC3B,UAAU,KAAK,QAAQ;gBACvB,MAAM,KAAK,IAAI;gBACf;gBACA;gBACA,SAAS,QAAQ,WAAW;gBAC5B,WAAW,QAAQ,aAAa;gBAChC,UAAU;gBACV,UAAU;YACZ;QACF;QAEA,2DAA2D;QAC3D,IAAI,CAAC,UAAU,CAAC,OAAO,SAAS,EAAE;YAChC,IAAI,IAAI,CAAC;gBACP,QAAQ;gBACR,UAAU;gBACV,WAAW;gBACX,QAAQ;YACV;YACA;QACF;QAEA,0CAA0C;QAC1C,IAAI,YAAY;QAChB,IAAI,OAAO,OAAO,EAAE;YAClB,YAAY,MAAM,OAAO,GAAG,CAAC,MAAM,CAAC;gBAClC,OAAO;oBAAE,MAAM,OAAO,OAAO;gBAAC;gBAC9B,QAAQ;oBACN,MAAM,OAAO,OAAO;oBACpB,SAAS,OAAO,UAAU,IAAI;oBAC9B,MAAM,OAAO,OAAO,IAAI;oBACxB,WAAW,OAAO,YAAY,IAAI;gBACpC;gBACA,QAAQ;oBACN,MAAM,OAAO,OAAO;oBACpB,MAAM,OAAO,OAAO;oBACpB,SAAS,OAAO,UAAU,IAAI;oBAC9B,MAAM,OAAO,OAAO,IAAI;oBACxB,WAAW,OAAO,YAAY,IAAI;gBACpC;YACF;QACF;QAEA,6CAA6C;QAC7C,MAAM,iBACJ,OAAO,cAAc,IAAI,OAAO,YAAY,IAAI,OAAO,YAAY,IAAI;QAEzE,IAAI,cAAc,MAAM,OAAO,KAAK,CAAC,SAAS,CAAC;YAC7C,OAAO;gBACL,WAAW,OAAO,SAAS;gBAC3B,GAAI,iBAAiB;oBAAE,WAAW;gBAAe,IAAI,CAAC,CAAC;YACzD;QACF;QAEA,IAAI,aAAa;YACf,cAAc,MAAM,OAAO,KAAK,CAAC,MAAM,CAAC;gBACtC,OAAO;oBAAE,IAAI,YAAY,EAAE;gBAAC;gBAC5B,MAAM;oBACJ,aAAa,OAAO,WAAW,IAAI,YAAY,WAAW;oBAC1D,iBAAiB,OAAO,UAAU,IAAI,YAAY,eAAe;oBACjE,cAAc,OAAO,YAAY,IAAI,YAAY,YAAY;oBAC7D,WAAW,kBAAkB,YAAY,SAAS;gBACpD;YACF;QACF,OAAO;YACL,cAAc,MAAM,OAAO,KAAK,CAAC,MAAM,CAAC;gBACtC,MAAM;oBACJ,WAAW,OAAO,SAAS;oBAC3B,aAAa,OAAO,WAAW,IAAI;oBACnC,iBAAiB,OAAO,UAAU,IAAI;oBACtC,cAAc,OAAO,YAAY,IAAI,kBAAkB;oBACvD,WAAW;oBACX,UAAU;gBACZ;YACF;QACF;QAEA,kFAAkF;QAClF,MAAM,YAAY,MAAM,OAAO,SAAS,CAAC,MAAM,CAAC;YAC9C,MAAM;gBACJ,OAAO;oBACL,SAAS;wBAAE,IAAI,YAAY,EAAE;oBAAC;gBAChC;gBACA,KAAK,YACD;oBACE,SAAS;wBAAE,IAAI,UAAU,EAAE;oBAAC;gBAC9B,IACA;gBACJ,kBAAkB;oBAChB,SAAS;wBAAE,IAAI,YAAY,EAAE;oBAAC;gBAChC;gBAEA,UAAU,OAAO,QAAQ,GAAG,IAAI,KAAK,OAAO,QAAQ,IAAI;gBACxD,YAAY,OAAO,UAAU,GAAG,IAAI,KAAK,OAAO,UAAU,IAAI;gBAE9D,YACE,OAAO,OAAO,UAAU,KAAK,WAAW,OAAO,UAAU,GAAG;gBAC9D,YACE,OAAO,OAAO,UAAU,KAAK,WAAW,OAAO,UAAU,GAAG;gBAC9D,0BACE,OAAO,OAAO,wBAAwB,KAAK,WACvC,OAAO,wBAAwB,GAC/B;gBACN,sBACE,OAAO,OAAO,oBAAoB,KAAK,WACnC,OAAO,oBAAoB,GAC3B;gBAEN,gBACE,OAAO,OAAO,cAAc,KAAK,YAC7B,OAAO,cAAc,GACrB;gBACN,cACE,OAAO,OAAO,YAAY,KAAK,YAC3B,OAAO,YAAY,GACnB;gBACN,iBACE,OAAO,OAAO,eAAe,KAAK,YAC9B,OAAO,eAAe,GACtB;gBACN,gBACE,OAAO,OAAO,cAAc,KAAK,YAC7B,OAAO,cAAc,GACrB;gBAEN,iBACE,OAAO,OAAO,eAAe,KAAK,WAC9B,OAAO,eAAe,GACtB;gBACN,eACE,OAAO,OAAO,aAAa,KAAK,WAC5B,OAAO,aAAa,GACpB;gBAEN,gBAAgB,OAAO,cAAc,IAAI;gBACzC,SAAS;gBACT,cAAc,OAAO,SAAS,IAAI;YACpC;QACF;QAEA,IAAI,IAAI,CAAC;YACP,QAAQ;YACR,UAAU;YACV;YACA;QACF;IACF,EAAE,OAAO,GAAQ;QACf,QAAQ,KAAK,CAAC,yBAAyB;QACvC,IACG,MAAM,CAAC,KACP,IAAI,CAAC;YAAE,OAAO,GAAG,WAAW;QAA8B;IAC/D;AACF"}}]
}