{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jesse/Documents/cartfax_complete_v2/pages/api/auth/%5B...nextauth%5D.ts"],"sourcesContent":["import NextAuth, { NextAuthOptions } from 'next-auth';\r\nimport CredentialsProvider from 'next-auth/providers/credentials';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport bcrypt from 'bcrypt';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\nexport const authOptions: NextAuthOptions = {\r\n  session: { strategy: 'jwt' },\r\n  providers: [\r\n    CredentialsProvider({\r\n      name: 'Credentials',\r\n      credentials: {\r\n        email: { label: 'Email', type: 'email', placeholder: 'admin@example.com' },\r\n        password: { label: 'Password', type: 'password' },\r\n      },\r\n      async authorize(credentials) {\r\n        if (!credentials?.email || !credentials?.password) return null;\r\n\r\n        const user = await prisma.adminUser.findUnique({\r\n          where: { email: credentials.email },\r\n        });\r\n        if (!user) return null;\r\n\r\n        const ok = await bcrypt.compare(credentials.password, user.password);\r\n        if (!ok) return null;\r\n\r\n        return {\r\n          id: user.id.toString(),\r\n          email: user.email,\r\n          name: user.name || undefined,\r\n          role: user.role,\r\n        } as any;\r\n      },\r\n    }),\r\n  ],\r\n  callbacks: {\r\n    async jwt({ token, user }) {\r\n      if (user) {\r\n        token.role = (user as any).role ?? 'admin';\r\n        token.id = (user as any).id ?? token.id;\r\n      }\r\n      return token;\r\n    },\r\n    async session({ session, token }) {\r\n      (session as any).user = session.user ?? {};\r\n      (session as any).user.role = token.role;\r\n      (session as any).user.id = token.id;\r\n      return session;\r\n    },\r\n  },\r\n  secret: process.env.NEXTAUTH_SECRET,\r\n};\r\n\r\nexport default NextAuth(authOptions);\r\n\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AACA;;;;;AAEA,MAAM,SAAS,IAAI,6IAAY;AAExB,MAAM,cAA+B;IAC1C,SAAS;QAAE,UAAU;IAAM;IAC3B,WAAW;QACT,IAAA,oLAAmB,EAAC;YAClB,MAAM;YACN,aAAa;gBACX,OAAO;oBAAE,OAAO;oBAAS,MAAM;oBAAS,aAAa;gBAAoB;gBACzE,UAAU;oBAAE,OAAO;oBAAY,MAAM;gBAAW;YAClD;YACA,MAAM,WAAU,WAAW;gBACzB,IAAI,CAAC,aAAa,SAAS,CAAC,aAAa,UAAU,OAAO;gBAE1D,MAAM,OAAO,MAAM,OAAO,SAAS,CAAC,UAAU,CAAC;oBAC7C,OAAO;wBAAE,OAAO,YAAY,KAAK;oBAAC;gBACpC;gBACA,IAAI,CAAC,MAAM,OAAO;gBAElB,MAAM,KAAK,MAAM,gHAAM,CAAC,OAAO,CAAC,YAAY,QAAQ,EAAE,KAAK,QAAQ;gBACnE,IAAI,CAAC,IAAI,OAAO;gBAEhB,OAAO;oBACL,IAAI,KAAK,EAAE,CAAC,QAAQ;oBACpB,OAAO,KAAK,KAAK;oBACjB,MAAM,KAAK,IAAI,IAAI;oBACnB,MAAM,KAAK,IAAI;gBACjB;YACF;QACF;KACD;IACD,WAAW;QACT,MAAM,KAAI,EAAE,KAAK,EAAE,IAAI,EAAE;YACvB,IAAI,MAAM;gBACR,MAAM,IAAI,GAAG,AAAC,KAAa,IAAI,IAAI;gBACnC,MAAM,EAAE,GAAG,AAAC,KAAa,EAAE,IAAI,MAAM,EAAE;YACzC;YACA,OAAO;QACT;QACA,MAAM,SAAQ,EAAE,OAAO,EAAE,KAAK,EAAE;YAC7B,QAAgB,IAAI,GAAG,QAAQ,IAAI,IAAI,CAAC;YACxC,QAAgB,IAAI,CAAC,IAAI,GAAG,MAAM,IAAI;YACtC,QAAgB,IAAI,CAAC,EAAE,GAAG,MAAM,EAAE;YACnC,OAAO;QACT;IACF;IACA,QAAQ,QAAQ,GAAG,CAAC,eAAe;AACrC;uCAEe,IAAA,4HAAQ,EAAC"}},
    {"offset": {"line": 120, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jesse/Documents/cartfax_complete_v2/pages/api/admin/batches.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from 'next';\nimport { PrismaClient } from '@prisma/client';\nimport { getServerSession } from 'next-auth/next';\nimport { authOptions } from '../auth/[...nextauth]';\n\nconst prisma = new PrismaClient();\n\nexport default async function handler(\n  req: NextApiRequest,\n  res: NextApiResponse\n) {\n  const session = await getServerSession(req, res, authOptions as any);\n\n  if (!session || (session.user as any).role !== 'admin') {\n    return res.status(403).json({ error: 'forbidden' });\n  }\n\n  // GET: list batches, optionally filtered by state and search query\n    if (req.method === 'GET') {\n    const { id, stateCode, q } = req.query;\n\n    // Detail view: GET /api/admin/batches?id=123\n    if (id) {\n      const batchId = Number(id);\n      if (!batchId) {\n        return res.status(400).json({ error: 'invalid id' });\n      }\n\n      const item = await prisma.batch.findUnique({\n        where: { id: batchId },\n        include: {\n          brand: true,\n          labResults: {\n            orderBy: { createdAt: 'desc' },\n            include: {\n              uploadedDocument: true, // make sure LabResult has this relation in schema\n            },\n          },\n        },\n      });\n\n      if (!item) {\n        return res.status(404).json({ error: 'not found' });\n      }\n\n      return res.json(item);\n    }\n\n    // List view (state + search)\n    const where: any = {};\n\n    if (stateCode && typeof stateCode === 'string') {\n      where.stateCode = stateCode.toUpperCase();\n    }\n\n    if (q && typeof q === 'string' && q.trim().length > 0) {\n      where.OR = [\n        { batchCode: { contains: q, mode: 'insensitive' } },\n        { productName: { contains: q, mode: 'insensitive' } },\n        { productCategory: { contains: q, mode: 'insensitive' } },\n        // remove this line if you don't have brand.name:\n        { brand: { name: { contains: q, mode: 'insensitive' } } },\n      ];\n    }\n\n    const items = await prisma.batch.findMany({\n      where,\n      orderBy: { createdAt: 'desc' },\n      include: {\n        brand: true,\n        labResults: true,\n      },\n    });\n\n    return res.json(items);\n  }\n\n\n  // POST: create batch\n  if (req.method === 'POST') {\n    const body = req.body || {};\n\n    const created = await prisma.batch.create({\n      data: {\n        batchCode: body.batchCode || '',\n        productName: body.productName || null,\n        productCategory: body.productCategory || null,\n        productSubcategory: body.productSubcategory || null,\n        brandId: body.brandId ?? null,\n        sku: body.sku || null,\n        stateCode: body.stateCode ? String(body.stateCode).toUpperCase() : null,\n        harvestDate: body.harvestDate ? new Date(body.harvestDate) : null,\n        productionDate: body.productionDate\n          ? new Date(body.productionDate)\n          : null,\n        packageDate: body.packageDate\n          ? new Date(body.packageDate)\n          : null,\n        expirationDate: body.expirationDate\n          ? new Date(body.expirationDate)\n          : null,\n        isActive: body.isActive === true,\n        notes: body.notes || null,\n      },\n    });\n\n    return res.status(201).json(created);\n  }\n\n  // PUT: update batch\n  if (req.method === 'PUT') {\n    const id = Number(req.query.id);\n    if (!id) {\n      return res.status(400).json({ error: 'missing id' });\n    }\n\n    const body = req.body || {};\n\n    const updated = await prisma.batch.update({\n      where: { id },\n      data: {\n        batchCode: body.batchCode || '',\n        productName: body.productName || null,\n        productCategory: body.productCategory || null,\n        productSubcategory: body.productSubcategory || null,\n        brandId: body.brandId ?? null,\n        sku: body.sku || null,\n        stateCode: body.stateCode ? String(body.stateCode).toUpperCase() : null,\n        harvestDate: body.harvestDate ? new Date(body.harvestDate) : null,\n        productionDate: body.productionDate\n          ? new Date(body.productionDate)\n          : null,\n        packageDate: body.packageDate\n          ? new Date(body.packageDate)\n          : null,\n        expirationDate: body.expirationDate\n          ? new Date(body.expirationDate)\n          : null,\n        isActive: body.isActive === true,\n        notes: body.notes || null,\n      },\n    });\n\n    return res.json(updated);\n  }\n\n  // DELETE: delete batch + its lab results\n  if (req.method === 'DELETE') {\n    const id = Number(req.query.id);\n    if (!id) {\n      return res.status(400).json({ error: 'missing id' });\n    }\n\n    try {\n      // delete all lab results that reference this batch\n      await prisma.labResult.deleteMany({\n        where: { batchId: id },\n      });\n\n      await prisma.batch.delete({\n        where: { id },\n      });\n\n      return res.json({ ok: true });\n    } catch (e: any) {\n      console.error('Failed to delete batch', e);\n      return res\n        .status(500)\n        .json({ error: e?.message || 'Failed to delete batch' });\n    }\n  }\n\n  return res.status(405).end();\n}\n"],"names":[],"mappings":"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"}}]
}