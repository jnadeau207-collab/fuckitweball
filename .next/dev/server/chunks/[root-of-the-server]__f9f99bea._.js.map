{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jesse/Documents/cartfax_complete_v2/pages/api/auth/%5B...nextauth%5D.ts"],"sourcesContent":["import NextAuth, { NextAuthOptions } from 'next-auth';\r\nimport CredentialsProvider from 'next-auth/providers/credentials';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport bcrypt from 'bcrypt';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\nexport const authOptions: NextAuthOptions = {\r\n  session: { strategy: 'jwt' },\r\n  providers: [\r\n    CredentialsProvider({\r\n      name: 'Credentials',\r\n      credentials: {\r\n        email: { label: 'Email', type: 'email', placeholder: 'admin@example.com' },\r\n        password: { label: 'Password', type: 'password' },\r\n      },\r\n      async authorize(credentials) {\r\n        if (!credentials?.email || !credentials?.password) return null;\r\n\r\n        const user = await prisma.adminUser.findUnique({\r\n          where: { email: credentials.email },\r\n        });\r\n        if (!user) return null;\r\n\r\n        const ok = await bcrypt.compare(credentials.password, user.password);\r\n        if (!ok) return null;\r\n\r\n        return {\r\n          id: user.id.toString(),\r\n          email: user.email,\r\n          name: user.name || undefined,\r\n          role: user.role,\r\n        } as any;\r\n      },\r\n    }),\r\n  ],\r\n  callbacks: {\r\n    async jwt({ token, user }) {\r\n      if (user) {\r\n        token.role = (user as any).role ?? 'admin';\r\n        token.id = (user as any).id ?? token.id;\r\n      }\r\n      return token;\r\n    },\r\n    async session({ session, token }) {\r\n      (session as any).user = session.user ?? {};\r\n      (session as any).user.role = token.role;\r\n      (session as any).user.id = token.id;\r\n      return session;\r\n    },\r\n  },\r\n  secret: process.env.NEXTAUTH_SECRET,\r\n};\r\n\r\nexport default NextAuth(authOptions);\r\n\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AACA;;;;;AAEA,MAAM,SAAS,IAAI,6IAAY;AAExB,MAAM,cAA+B;IAC1C,SAAS;QAAE,UAAU;IAAM;IAC3B,WAAW;QACT,IAAA,oLAAmB,EAAC;YAClB,MAAM;YACN,aAAa;gBACX,OAAO;oBAAE,OAAO;oBAAS,MAAM;oBAAS,aAAa;gBAAoB;gBACzE,UAAU;oBAAE,OAAO;oBAAY,MAAM;gBAAW;YAClD;YACA,MAAM,WAAU,WAAW;gBACzB,IAAI,CAAC,aAAa,SAAS,CAAC,aAAa,UAAU,OAAO;gBAE1D,MAAM,OAAO,MAAM,OAAO,SAAS,CAAC,UAAU,CAAC;oBAC7C,OAAO;wBAAE,OAAO,YAAY,KAAK;oBAAC;gBACpC;gBACA,IAAI,CAAC,MAAM,OAAO;gBAElB,MAAM,KAAK,MAAM,gHAAM,CAAC,OAAO,CAAC,YAAY,QAAQ,EAAE,KAAK,QAAQ;gBACnE,IAAI,CAAC,IAAI,OAAO;gBAEhB,OAAO;oBACL,IAAI,KAAK,EAAE,CAAC,QAAQ;oBACpB,OAAO,KAAK,KAAK;oBACjB,MAAM,KAAK,IAAI,IAAI;oBACnB,MAAM,KAAK,IAAI;gBACjB;YACF;QACF;KACD;IACD,WAAW;QACT,MAAM,KAAI,EAAE,KAAK,EAAE,IAAI,EAAE;YACvB,IAAI,MAAM;gBACR,MAAM,IAAI,GAAG,AAAC,KAAa,IAAI,IAAI;gBACnC,MAAM,EAAE,GAAG,AAAC,KAAa,EAAE,IAAI,MAAM,EAAE;YACzC;YACA,OAAO;QACT;QACA,MAAM,SAAQ,EAAE,OAAO,EAAE,KAAK,EAAE;YAC7B,QAAgB,IAAI,GAAG,QAAQ,IAAI,IAAI,CAAC;YACxC,QAAgB,IAAI,CAAC,IAAI,GAAG,MAAM,IAAI;YACtC,QAAgB,IAAI,CAAC,EAAE,GAAG,MAAM,EAAE;YACnC,OAAO;QACT;IACF;IACA,QAAQ,QAAQ,GAAG,CAAC,eAAe;AACrC;uCAEe,IAAA,4HAAQ,EAAC"}},
    {"offset": {"line": 120, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jesse/Documents/cartfax_complete_v2/lib/coaParser.ts"],"sourcesContent":["// lib/coaParser.ts\r\n\r\nexport type ParsedFailure = {\r\n  analyte: string;\r\n  category: string;\r\n  line: string;\r\n};\r\n\r\nexport type ParsedCOASummary = {\r\n  batchCode?: string | null;\r\n  productName?: string | null;\r\n  labName?: string | null;\r\n  matrix?: string | null;\r\n  sampleId?: string | null;\r\n  collectedOn?: string | null;\r\n  receivedOn?: string | null;\r\n  batchSizeGrams?: number | null;\r\n  sampleSizeGrams?: number | null;\r\n\r\n  thcPercent?: number | null;\r\n  cbdPercent?: number | null;\r\n  totalCannabinoidsPercent?: number | null;\r\n  totalTerpenesPercent?: number | null;\r\n  moisturePercent?: number | null;\r\n  waterActivity?: number | null;\r\n\r\n  batchResult?: 'PASS' | 'FAIL' | 'UNKNOWN';\r\n  hasAnyFailure: boolean;\r\n  failureReasons: ParsedFailure[];\r\n};\r\n\r\nexport type ParsedCOA = {\r\n  summary: ParsedCOASummary;\r\n  rawSections: {\r\n    potency?: string;\r\n    terpenes?: string;\r\n    pesticides?: string;\r\n    microbials?: string;\r\n    mycotoxins?: string;\r\n    heavyMetals?: string;\r\n    solvents?: string;\r\n    notes?: string;\r\n  };\r\n};\r\n\r\n/**\r\n * Utility: normalize line endings and compress multiple spaces\r\n */\r\nfunction normalizeText(input: string): string {\r\n  return input.replace(/\\r\\n/g, '\\n');\r\n}\r\n\r\n/**\r\n * Utility: extract first match group as string or null\r\n */\r\nfunction matchGroup(text: string, regex: RegExp, groupIndex = 1): string | null {\r\n  const m = text.match(regex);\r\n  if (!m || !m[groupIndex]) return null;\r\n  return m[groupIndex].trim();\r\n}\r\n\r\n/**\r\n * Utility: extract number from a matched group like \"28.5 %\"\r\n */\r\nfunction matchNumber(\r\n  text: string,\r\n  regex: RegExp,\r\n  groupIndex = 1\r\n): number | null {\r\n  const s = matchGroup(text, regex, groupIndex);\r\n  if (!s) return null;\r\n  const cleaned = s.replace(/[^\\d.\\-]/g, '');\r\n  const n = Number(cleaned);\r\n  return Number.isNaN(n) ? null : n;\r\n}\r\n\r\n/**\r\n * Utility: slice text between two markers (best effort)\r\n */\r\nfunction sliceBetween(\r\n  text: string,\r\n  startMarker: string,\r\n  endMarkers: string[]\r\n): string | undefined {\r\n  const lower = text.toLowerCase();\r\n  const startIdx = lower.indexOf(startMarker.toLowerCase());\r\n  if (startIdx === -1) return undefined;\r\n\r\n  let endIdx = text.length;\r\n  for (const end of endMarkers) {\r\n    const idx = lower.indexOf(end.toLowerCase(), startIdx + startMarker.length);\r\n    if (idx !== -1 && idx < endIdx) {\r\n      endIdx = idx;\r\n    }\r\n  }\r\n\r\n  return text.slice(startIdx, endIdx).trim();\r\n}\r\n\r\n/**\r\n * Scan the whole text for FAIL lines and try to infer category + analyte name.\r\n */\r\nfunction detectFailures(text: string): ParsedFailure[] {\r\n  const lines = text.split('\\n').map((l) => l.trim()).filter(Boolean);\r\n  const failures: ParsedFailure[] = [];\r\n\r\n  for (const line of lines) {\r\n    if (!/FAIL\\b/i.test(line)) continue;\r\n\r\n    // crude heuristics to guess category by context keywords\r\n    let category = 'Unknown';\r\n    const lower = line.toLowerCase();\r\n    if (lower.includes('mycotoxin')) category = 'Mycotoxins';\r\n    else if (lower.includes('yeast') || lower.includes('mold') || lower.includes('bacteria') || lower.includes('salmonella') || lower.includes('coli') || lower.includes('enterobacter')) {\r\n      category = 'Microbials';\r\n    } else if (\r\n      lower.includes('pesticide') ||\r\n      lower.includes('fungicide') ||\r\n      lower.includes('insecticide') ||\r\n      lower.includes('growth regulator') ||\r\n      lower.includes('μg/kg')\r\n    ) {\r\n      category = 'Pesticides';\r\n    } else if (\r\n      lower.includes('arsenic') ||\r\n      lower.includes('cadmium') ||\r\n      lower.includes('lead') ||\r\n      lower.includes('mercury')\r\n    ) {\r\n      category = 'Heavy metals';\r\n    } else if (\r\n      lower.includes('butane') ||\r\n      lower.includes('propane') ||\r\n      lower.includes('solvent')\r\n    ) {\r\n      category = 'Solvents';\r\n    } else if (lower.includes('hop latent viroid') || lower.includes('virus')) {\r\n      category = 'Viral / plant health';\r\n    }\r\n\r\n    // analyte is usually at the start of the line until a double-space or number chunk\r\n    const analyteMatch = line.match(/^([A-Z0-9\\-\\.\\s]+?)(\\d|<|N|P|F|μ|µ|$)/i);\r\n    const analyte = analyteMatch ? analyteMatch[1].trim() : 'Unknown analyte';\r\n\r\n    failures.push({\r\n      analyte,\r\n      category,\r\n      line,\r\n    });\r\n  }\r\n\r\n  return failures;\r\n}\r\n\r\n/**\r\n * Main entrypoint: parse COA text into structured-ish data.\r\n * This is deliberately tolerant: it will fill what it can and leave the rest null.\r\n */\r\nexport function parseCoaText(raw: string): ParsedCOA {\r\n  const text = normalizeText(raw);\r\n\r\n  // Top-level summary values\r\n  const batchCode =\r\n    matchGroup(text, /BATCH:\\s*([A-Za-z0-9\\-\\._]+)/i) ??\r\n    matchGroup(text, /BATCH ID:\\s*([A-Za-z0-9\\-\\._]+)/i) ??\r\n    null;\r\n\r\n  const productName =\r\n    matchGroup(text, /COA EXAMPLE.*\\(([^)]+)\\)/i) ??\r\n    matchGroup(text, /COA .*?FOR\\s+([^\\/\\n]+)\\//i) ??\r\n    null;\r\n\r\n  const labName =\r\n    matchGroup(text, /([A-Z][A-Z0-9\\s]+LABS)\\b/) ??\r\n    matchGroup(text, /CLIENT:\\s*([A-Z0-9\\s\\-]+)\\s*\\/\\//i) ??\r\n    null;\r\n\r\n  const matrix =\r\n    matchGroup(text, /MATRIX:\\s*([A-Z0-9 ]+)/i) ?? null;\r\n\r\n  const sampleId =\r\n    matchGroup(text, /SAMPLE ID:\\s*([A-Za-z0-9\\-]+)/i) ?? null;\r\n\r\n  const collectedOn =\r\n    matchGroup(text, /COLLECTED ON:\\s*([A-Za-z]{3}\\s+\\d{1,2},\\s+\\d{4})/i) ??\r\n    matchGroup(text, /COLLECTED ON:\\s*([A-Za-z0-9 ,/]+)/i) ??\r\n    null;\r\n\r\n  const receivedOn =\r\n    matchGroup(text, /RECEIVED ON:\\s*([A-Za-z]{3}\\s+\\d{1,2},\\s+\\d{4})/i) ??\r\n    matchGroup(text, /RECEIVED ON:\\s*([A-Za-z0-9 ,/]+)/i) ??\r\n    null;\r\n\r\n  const batchSizeGrams =\r\n    matchNumber(text, /BATCH SIZE:\\s*([0-9.,]+)\\s*G/i) ?? null;\r\n\r\n  const sampleSizeGrams =\r\n    matchNumber(text, /SAMPLE SIZE:\\s*([0-9.,]+)\\s*G/i) ?? null;\r\n\r\n  const thcPercent =\r\n    matchNumber(text, /Δ-?THC:?\\s*([0-9]+(?:\\.[0-9]+)?)\\s*%/i) ??\r\n    matchNumber(text, /TOTAL THC\\s*([0-9]+(?:\\.[0-9]+)?)\\s*%/i) ??\r\n    null;\r\n\r\n  const cbdPercent =\r\n    matchNumber(text, /CBD:?\\s*([0-9]+(?:\\.[0-9]+)?)\\s*%/i) ??\r\n    matchNumber(text, /TOTAL CBD\\s*([0-9]+(?:\\.[0-9]+)?)\\s*%/i) ??\r\n    null;\r\n\r\n  const totalCannabinoidsPercent =\r\n    matchNumber(text, /TOTAL CANNABINOIDS:?\\s*([0-9]+(?:\\.[0-9]+)?)\\s*%/i) ??\r\n    null;\r\n\r\n  const totalTerpenesPercent =\r\n    matchNumber(text, /TOTAL TERPENES\\s*([0-9]+(?:\\.[0-9]+)?)\\s*%/i) ?? null;\r\n\r\n  const moisturePercent =\r\n    matchNumber(text, /MOISTURE\\s*([0-9]+(?:\\.[0-9]+)?)\\s*%/i) ?? null;\r\n\r\n  const waterActivity =\r\n    matchNumber(text, /WATER ACTIVITY\\s*([0-9]+(?:\\.[0-9]+)?)\\s*Aw/i) ?? null;\r\n\r\n  const batchResultRaw =\r\n    matchGroup(text, /BATCH RESULT:\\s*(PASS|FAIL)/i) ?? null;\r\n\r\n  const batchResult: 'PASS' | 'FAIL' | 'UNKNOWN' =\r\n    batchResultRaw?.toUpperCase() === 'PASS'\r\n      ? 'PASS'\r\n      : batchResultRaw?.toUpperCase() === 'FAIL'\r\n      ? 'FAIL'\r\n      : 'UNKNOWN';\r\n\r\n  const failures = detectFailures(text);\r\n  const hasAnyFailure =\r\n    batchResult === 'FAIL' || (failures && failures.length > 0);\r\n\r\n  // Raw sections to show in debug viewer\r\n  const potencySection = sliceBetween(text, 'CAN.1: POTENCY', [\r\n    'TERPENES BY',\r\n    'RSOL.1',\r\n    'RESIDUAL SOLVENTS',\r\n  ]);\r\n\r\n  const terpenesSection = sliceBetween(text, 'TERPENES BY', [\r\n    'RSOL.1',\r\n    'RESIDUAL SOLVENTS',\r\n    'PST.2',\r\n  ]);\r\n\r\n  const pesticidesSection = sliceBetween(text, 'PST.2:', [\r\n    'MYC.1:',\r\n    'HME.1:',\r\n    'HEAVY METALS',\r\n  ]);\r\n\r\n  const mycotoxinsSection = sliceBetween(text, 'MYC.1:', [\r\n    'HME.1:',\r\n    'HEAVY METALS',\r\n    'FMT.1:',\r\n  ]);\r\n\r\n  const heavyMetalsSection = sliceBetween(text, 'HME.1:', [\r\n    'FMT.1:',\r\n    'FILTH AND FOREIGN',\r\n    'MOISTURE CONTENT',\r\n  ]);\r\n\r\n  const solventsSection = sliceBetween(text, 'RSOL.1:', [\r\n    'PST.2',\r\n    'MYC.1',\r\n  ]);\r\n\r\n  const microbialsSection = sliceBetween(text, 'TOTAL YEAST AND MOLD', [\r\n    'NOTES',\r\n    'END OF REPORT',\r\n  ]);\r\n\r\n  const notesSection = sliceBetween(text, 'NOTES', ['END OF REPORT']);\r\n\r\n  const summary: ParsedCOASummary = {\r\n    batchCode,\r\n    productName,\r\n    labName,\r\n    matrix,\r\n    sampleId,\r\n    collectedOn,\r\n    receivedOn,\r\n    batchSizeGrams,\r\n    sampleSizeGrams,\r\n    thcPercent,\r\n    cbdPercent,\r\n    totalCannabinoidsPercent,\r\n    totalTerpenesPercent,\r\n    moisturePercent,\r\n    waterActivity,\r\n    batchResult,\r\n    hasAnyFailure,\r\n    failureReasons: failures,\r\n  };\r\n\r\n  return {\r\n    summary,\r\n    rawSections: {\r\n      potency: potencySection,\r\n      terpenes: terpenesSection,\r\n      pesticides: pesticidesSection,\r\n      microbials: microbialsSection,\r\n      mycotoxins: mycotoxinsSection,\r\n      heavyMetals: heavyMetalsSection,\r\n      solvents: solventsSection,\r\n      notes: notesSection,\r\n    },\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 309, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jesse/Documents/cartfax_complete_v2/pages/api/admin/uploads/%5Bid%5D.ts"],"sourcesContent":["// pages/api/admin/uploads/[id].ts\r\n\r\nimport type { NextApiRequest, NextApiResponse } from 'next';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { getServerSession } from 'next-auth/next';\r\nimport { authOptions } from '../../auth/[...nextauth]';\r\nimport { parseCoaText } from '../../../../lib/coaParser';\r\n\r\nimport fs from 'fs';\r\nimport path from 'path';\r\nimport pdf from 'pdf-parse';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\nasync function ensureExtractedText(doc: any) {\r\n  // Try existing text fields first\r\n  let rawText: string =\r\n    doc.extractedText || doc.textContent || doc.rawText || '';\r\n\r\n  if (rawText && rawText.trim().length > 0) {\r\n    return rawText;\r\n  }\r\n\r\n  // No text yet – try to read from disk using a few possible field names\r\n  const storagePath: string | undefined =\r\n    doc.storagePath || doc.filePath || doc.localPath;\r\n\r\n  if (!storagePath) {\r\n    console.warn(\r\n      'UploadedDocument has no extracted text and no storagePath/filePath/localPath'\r\n    );\r\n    return '';\r\n  }\r\n\r\n  try {\r\n    // Make absolute if it isn't already\r\n    const absPath = path.isAbsolute(storagePath)\r\n      ? storagePath\r\n      : path.join(process.cwd(), storagePath);\r\n\r\n    const fileBuffer = fs.readFileSync(absPath);\r\n    const pdfData = await pdf(fileBuffer);\r\n    rawText = pdfData.text || '';\r\n\r\n    // Persist for future calls if we got anything\r\n    if (rawText && rawText.trim().length > 0) {\r\n      await prisma.uploadedDocument.update({\r\n        where: { id: doc.id },\r\n        data: { extractedText: rawText },\r\n      });\r\n    }\r\n\r\n    return rawText;\r\n  } catch (e) {\r\n    console.error('Failed to extract text from PDF file', e);\r\n    return '';\r\n  }\r\n}\r\n\r\nexport default async function handler(\r\n  req: NextApiRequest,\r\n  res: NextApiResponse\r\n) {\r\n  const session = await getServerSession(req, res, authOptions as any);\r\n\r\n  if (!session || (session.user as any).role !== 'admin') {\r\n    return res.status(403).json({ error: 'forbidden' });\r\n  }\r\n\r\n  const { id } = req.query;\r\n  const idNum = Number(id);\r\n\r\n  if (!id || Number.isNaN(idNum)) {\r\n    return res.status(400).json({ error: 'invalid id' });\r\n  }\r\n\r\n  if (req.method === 'GET') {\r\n    try {\r\n      const doc = await prisma.uploadedDocument.findUnique({\r\n        where: { id: idNum },\r\n        include: {\r\n          labResult: {\r\n            include: {\r\n              batch: true,\r\n              lab: true,\r\n            },\r\n          },\r\n        },\r\n      });\r\n\r\n      if (!doc) {\r\n        return res.status(404).json({ error: 'not found' });\r\n      }\r\n\r\n      const anyDoc = doc as any;\r\n\r\n      // ✅ Make sure we actually have text; extract from PDF if needed\r\n      const rawText = await ensureExtractedText(anyDoc);\r\n\r\n      const parseResult = rawText ? parseCoaText(rawText) : null;\r\n\r\n      // Trim huge text for debug: keep first ~20k chars\r\n      const rawTextPreview =\r\n        rawText && rawText.length > 20000\r\n          ? rawText.slice(0, 20000) + '\\n\\n[truncated for display]'\r\n          : rawText;\r\n\r\n      return res.json({\r\n        id: doc.id,\r\n        fileName: doc.fileName,\r\n        createdAt: doc.createdAt,\r\n        mimeType: anyDoc.mimeType ?? null,\r\n        sizeBytes: anyDoc.sizeBytes ?? null,\r\n        labResult: doc.labResult,\r\n        batch: doc.labResult?.batch ?? null,\r\n        lab: doc.labResult?.lab ?? null,\r\n        rawTextPreview,\r\n        parseResult,\r\n      });\r\n    } catch (e: any) {\r\n      console.error('Failed to load upload debug info', e);\r\n      return res\r\n        .status(500)\r\n        .json({ error: e?.message || 'Failed to load upload debug info' });\r\n    }\r\n  }\r\n\r\n  if (req.method === 'DELETE') {\r\n    try {\r\n      const doc = await prisma.uploadedDocument.findUnique({\r\n        where: { id: idNum },\r\n        select: {\r\n          id: true,\r\n          labResultId: true,\r\n        },\r\n      });\r\n\r\n      if (!doc) {\r\n        return res.status(404).json({ error: 'not found' });\r\n      }\r\n\r\n      await prisma.$transaction(async (tx) => {\r\n        if (doc.labResultId) {\r\n          await tx.labResult.delete({\r\n            where: { id: doc.labResultId },\r\n          });\r\n        }\r\n\r\n        await tx.uploadedDocument.delete({\r\n          where: { id: doc.id },\r\n        });\r\n      });\r\n\r\n      return res.json({ ok: true });\r\n    } catch (e: any) {\r\n      console.error('Failed to delete upload / lab result', e);\r\n      return res\r\n        .status(500)\r\n        .json({ error: e?.message || 'Failed to delete upload / lab result' });\r\n    }\r\n  }\r\n\r\n  return res.status(405).end();\r\n}\r\n"],"names":[],"mappings":"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"}}]
}