{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jesse/Documents/cartfax_complete_v2/pages/api/admin/uploads/%5Bid%5D.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from 'next';\r\nimport { getServerSession } from 'next-auth/next';\r\nimport { authOptions } from '../auth/[...nextauth]';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport multer from 'multer';\r\nimport pdfParse from 'pdf-parse';\r\nimport crypto from 'crypto';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\n// Use in-memory storage for uploaded files\r\nconst upload = multer({ storage: multer.memoryStorage() });\r\n\r\n// Helper to run multer as a promise\r\nfunction runMiddleware(\r\n  req: NextApiRequest,\r\n  res: NextApiResponse,\r\n  fn: any\r\n): Promise<void> {\r\n  return new Promise((resolve, reject) => {\r\n    fn(req, res, (result: any) => {\r\n      if (result instanceof Error) return reject(result);\r\n      return resolve(result);\r\n    });\r\n  });\r\n}\r\n\r\n// GET  /api/admin/uploads       -> list uploads\r\n// POST /api/admin/uploads       -> upload + parse a PDF\r\n// (DELETE by id handled in /api/admin/uploads/[id].ts)\r\n\r\nexport default async function handler(\r\n  req: NextApiRequest,\r\n  res: NextApiResponse\r\n) {\r\n  const session = await getServerSession(req, res, authOptions as any);\r\n\r\n  if (!session) {\r\n    return res.status(401).json({ error: 'Unauthorized' });\r\n  }\r\n\r\n  if (req.method === 'GET') {\r\n    try {\r\n      const docs = await prisma.uploadedDocument.findMany({\r\n        orderBy: { createdAt: 'desc' },\r\n        select: {\r\n          id: true,\r\n          fileName: true,\r\n          mimeType: true,\r\n          size: true,\r\n          sha256: true,\r\n          batchCode: true,\r\n          labName: true,\r\n          createdAt: true,\r\n          verified: true,\r\n          // Don’t send extractedText in the list view for performance\r\n          labResult: {\r\n            select: {\r\n              id: true,\r\n            },\r\n          },\r\n        },\r\n      });\r\n\r\n      return res.json(docs);\r\n    } catch (e: any) {\r\n      console.error('Error listing uploads', e);\r\n      return res\r\n        .status(500)\r\n        .json({ error: e?.message || 'Failed to list uploads' });\r\n    }\r\n  }\r\n\r\n  if (req.method === 'POST') {\r\n    try {\r\n      // Parse multipart/form-data with multer\r\n      await runMiddleware(req, res, upload.single('file'));\r\n      const file = (req as any).file as Express.Multer.File | undefined;\r\n\r\n      if (!file) {\r\n        return res.status(400).json({ error: 'No file uploaded' });\r\n      }\r\n\r\n      if (file.mimetype !== 'application/pdf') {\r\n        return res.status(400).json({ error: 'Only PDF files are allowed' });\r\n      }\r\n\r\n      // Compute hash for dedupe\r\n      const hash = crypto\r\n        .createHash('sha256')\r\n        .update(file.buffer)\r\n        .digest('hex');\r\n\r\n      // Check for existing upload with same hash\r\n      const existing = await prisma.uploadedDocument.findUnique({\r\n        where: { sha256: hash },\r\n        include: {\r\n          labResult: true,\r\n        },\r\n      });\r\n\r\n      if (existing) {\r\n        return res.json({\r\n          reused: true,\r\n          document: existing,\r\n          labResult: existing.labResult || null,\r\n        });\r\n      }\r\n\r\n      // Extract text from PDF\r\n      let extractedText: string | null = null;\r\n      try {\r\n        const parsed = await pdfParse(file.buffer);\r\n        const raw = (parsed.text || '').trim();\r\n        extractedText = raw.length > 0 ? raw : null;\r\n      } catch (e) {\r\n        console.error('Failed to parse PDF text', e);\r\n        extractedText = null;\r\n      }\r\n\r\n      // Very light heuristics: try to detect batch code and lab name\r\n      let detectedBatchCode: string | null = null;\r\n      let detectedLabName: string | null = null;\r\n\r\n      if (extractedText) {\r\n        // Example: lines that start with \"BATCH:\" or \"BATCH\"\r\n        const lines = extractedText.split(/\\r?\\n/).map((l) => l.trim());\r\n\r\n        for (const line of lines) {\r\n          if (!detectedBatchCode) {\r\n            const m =\r\n              line.match(/^(batch|lot|metrc id)\\s*[:#-]?\\s*(.+)$/i) ||\r\n              line.match(/batch\\s*[:#-]\\s*([A-Za-z0-9\\-_.]+)/i);\r\n            if (m) {\r\n              detectedBatchCode = (m[2] || m[1] || '').trim();\r\n            }\r\n          }\r\n\r\n          if (!detectedLabName) {\r\n            // Very rough: look for \"LABS\" / \"LABORATORY\" / \"ANALYTIC LABS\"\r\n            if (\r\n              /labs?|laborator(y|ies)/i.test(line) &&\r\n              line.length <= 80 &&\r\n              !/limit|result|analysis/i.test(line)\r\n            ) {\r\n              detectedLabName = line;\r\n            }\r\n          }\r\n\r\n          if (detectedBatchCode && detectedLabName) break;\r\n        }\r\n      }\r\n\r\n      // Create the UploadedDocument row with extracted text\r\n      const document = await prisma.uploadedDocument.create({\r\n        data: {\r\n          fileName: file.originalname,\r\n          mimeType: file.mimetype,\r\n          size: file.size,\r\n          sha256: hash,\r\n          batchCode: detectedBatchCode,\r\n          labName: detectedLabName,\r\n          extractedText,\r\n          verified: false,\r\n        },\r\n      });\r\n\r\n      // Optionally: create a LabResult shell and try to pull potency\r\n      // from the extracted text. (Keeps your “lab result #X” UI working.)\r\n\r\n      let labResult = null as any;\r\n\r\n      if (extractedText) {\r\n        // quick-and-dirty THC / CBD / total regexes\r\n        const thcMatch =\r\n          extractedText.match(/THC\\s*[:=]\\s*([0-9]+(?:\\.[0-9]+)?)\\s*%/i) ||\r\n          extractedText.match(/Δ-?9?-?THC\\s*[:=]\\s*([0-9]+(?:\\.[0-9]+)?)\\s*%/i);\r\n\r\n        const cbdMatch = extractedText.match(\r\n          /CBD\\s*[:=]\\s*([0-9]+(?:\\.[0-9]+)?)\\s*%/i\r\n        );\r\n\r\n        const totalMatch =\r\n          extractedText.match(\r\n            /TOTAL CANNABINOIDS?\\s*[:=]\\s*([0-9]+(?:\\.[0-9]+)?)\\s*%/i\r\n          ) ||\r\n          extractedText.match(\r\n            /TOTAL THC\\s*[:=]\\s*([0-9]+(?:\\.[0-9]+)?)\\s*%/i\r\n          );\r\n\r\n        const thcPercent = thcMatch ? parseFloat(thcMatch[1]) : null;\r\n        const cbdPercent = cbdMatch ? parseFloat(cbdMatch[1]) : null;\r\n        const totalCannabinoidsPercent = totalMatch\r\n          ? parseFloat(totalMatch[1])\r\n          : null;\r\n\r\n        labResult = await prisma.labResult.create({\r\n          data: {\r\n            uploadedDocument: { connect: { id: document.id } },\r\n            thcPercent,\r\n            cbdPercent,\r\n            totalCannabinoidsPercent,\r\n            // leave passed / testedAt null for now; editable in debug UI\r\n          },\r\n        });\r\n      }\r\n\r\n      return res.json({\r\n        reused: false,\r\n        document,\r\n        labResult,\r\n      });\r\n    } catch (e: any) {\r\n      console.error('Error handling upload', e);\r\n      return res\r\n        .status(500)\r\n        .json({ error: e?.message || 'Failed to upload COA' });\r\n    }\r\n  }\r\n\r\n  return res.status(405).json({ error: 'Method not allowed' });\r\n}\r\n\r\n// Tell Next.js not to parse the body, we’re using multer\r\nexport const config = {\r\n  api: {\r\n    bodyParser: false,\r\n  },\r\n};\r\n"],"names":[],"mappings":"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"}}]
}